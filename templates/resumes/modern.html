<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ (name or fullName or full_name) ~ (' – ' ~ title if title) }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  {% set base_css  = url_for('static', filename='css/resume-base.css') if not for_pdf else 'static/css/resume-base.css' %}
  {% set theme_css = url_for('static', filename='css/modern.css')      if not for_pdf else 'static/css/modern.css' %}
  <link rel="stylesheet" href="{{ base_css }}">
  <link rel="stylesheet" href="{{ theme_css }}">

  {# PDF & screen overrides — inline, no extra file #}
  <style>
    /* Keep shadows for screen only (WeasyPrint won’t parse these in print mode) */
    @media screen {
      .card, .resume, .rb-card, .preview-wrap { box-shadow: 0 4px 18px rgba(16,72,121,.06); }
    }

    /* Print/PDF: WeasyPrint ignores box-shadow, so give a subtle border instead */
    @media print {
      .card, .section, .resume, .rb-card, .preview-wrap { border: 1px solid #e5e7eb; }
      @page { size: A4; margin: 18mm 16mm; }
      /* tighten spacing so sections sit closer (no big gaps) */
      .section { margin: 10px 0 12px; }
      .item-title { margin: 0 0 2px; }
      .item-sub { margin: 0 0 10px; }
    }

    {# If you want *zero* WeasyPrint warnings, you can also gate the entire screen CSS
       when rendering for PDF: skip screen CSS when for_pdf is true. See next block. #}
  </style>

  {# Optional: if you want to totally avoid WeasyPrint parsing screen CSS, skip it #}
  {% if for_pdf %}
  <style>
    /* Same rules as in @media print — applied unconditionally for PDF builds */
    .card, .section, .resume, .rb-card, .preview-wrap { border: 1px solid #e5e7eb; }
    @page { size: A4; margin: 18mm 16mm; }
    .section { margin: 10px 0 12px; }
    .item-title { margin: 0 0 2px; }
    .item-sub { margin: 0 0 10px; }
  </style>
  {% endif %}

  {# Watermark logic: free = JOBCUS.COM, paid = none #}
  {% set is_paid = current_user.is_authenticated and (current_user.plan|lower in ['standard','premium']) %}
  {% set wm_text = 'JOBCUS.COM' if not is_paid else '' %}

  {# Inline CSS so it also affects PDF (WeasyPrint ignores JS) #}
  <style>
    {% if wm_text %}
    body[data-watermark]::before{
      content: attr(data-watermark);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%) rotate(-32deg);
      font: 72px/1.1 Arial, Helvetica, sans-serif;
      color: rgba(0,0,0,.12);
      letter-spacing: 2px;
      white-space: nowrap;
      user-select: none;
      pointer-events: none;
      z-index: 9999;
    }
    @media print {
      body[data-watermark]::before{ opacity: 0.95; }
    }
    {% endif %}
  </style>

  {% if not for_pdf %}
    <script type="module" src="{{ url_for('static', filename='js/modern.js') }}"></script>
  {% endif %}
</head>
<body {% if wm_text %}data-watermark="{{ wm_text }}"{% endif %}>
  <div class="resume-page resume resume--modern">
    <header class="resume-header hero">
      <div class="resume-name">{{ name or fullName or full_name or 'Your Name' }}</div>
      {% if title %}<div class="resume-title">{{ title }}</div>{% endif %}
      <div class="resume-contact">
        {% if contact %}{{ contact }}{% endif %}
        {% for l in links %}
          {% if l.url %} · <a href="{{ l.url }}">{{ l.label or l.url }}</a>{% endif %}
        {% endfor %}
      </div>
    </header>

    {% if summary %}
    <section class="section">
      <h2>Professional Summary</h2>
      <div class="rule"></div>
      <div class="summary">{{ summary }}</div>
    </section>
    {% endif %}

    {% if skills %}
    <section class="section skills-section">
      <h2>Skills</h2>
      <div class="rule"></div>
      {% set skills_list = skills if skills is iterable and skills is not string else (skills.split(',') if skills else []) %}
      <ul class="skills-list">
        {% for s in skills_list if s %}<li>{{ s|trim }}</li>{% endfor %}
      </ul>
    </section>
    {% endif %}

    {% if experience %}
    <section class="section experience-section">
      <h2>Relevant Experience</h2>
      <div class="rule"></div>
      {% for e in experience %}
        <article class="item">
          <div class="item-header">
            <div class="item-title">
              {{ e.role }}{% if e.company %} – {{ e.company }}{% endif %}
            </div>
            {% if e.location %}
              <div class="item-meta">{{ e.location }}</div>
            {% endif %}
            {% if e.start or e.end %}
              <div class="item-meta">
                {% if e.start %}{{ e.start }}{% endif %}{% if e.end %} · {{ e.end }}{% endif %}
              </div>
            {% endif %}
          </div>
          {% if e.bullets %}<ul class="bullets">{% for b in e.bullets %}<li>{{ b }}</li>{% endfor %}</ul>{% endif %}
        </article>
      {% endfor %}
    </section>
    {% endif %}

    {% if education and education|length %}
    <section class="section section-education">
      <h2>Education</h2>
      <hr class="rule">
    
      {% for ed in education %}
        <div class="item">
          <h3 class="item-title">{{ ed.degree or ed.program or ed.title }}</h3>
    
          {# build date string (start/end) #}
          {% set start = (ed.graduatedStart or ed.start) | trim %}
          {% set end   = (ed.graduated or ed.end) | trim %}
          {% set date_bits = [] %}
          {% if start %}{% set _ = date_bits.append(start) %}{% endif %}
          {% if end %}{% set _ = date_bits.append(end) %}{% endif %}
          {% set date_line = date_bits | list | join(' – ') %}
    
          {# school + location #}
          {% set school_line = [ed.school, ed.location] | reject('equalto','') | list | join(' | ') %}
    
          {% if school_line or date_line %}
            <div class="item-sub">
              {{ school_line }}
              {% if date_line %} – {{ date_line }}{% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </section>
    {% endif %}

    {% set cert_list =
         certifications if certifications is iterable and certifications is not string
         else (certifications.split('\n') if certifications else []) %}
    {% if cert_list and cert_list|length %}

    {% set pa_list =
         projects_awards if projects_awards is iterable and projects_awards is not string
         else (projects_awards.split('\n') if projects_awards else []) %}
    {% if pa_list and pa_list|length %}
    <section class="section">
      <h2>Projects & Awards</h2>
      <div class="rule"></div>
      <ul class="bullets">
        {% for item in pa_list if item %}<li>{{ item|trim }}</li>{% endfor %}
      </ul>
    </section>
    {% endif %}

    <section class="section">
      <h2>Other Education & Certifications</h2>
      <div class="rule"></div>
      <ul class="bullets">
        {% for c in cert_list if c %}<li>{{ c|trim }}</li>{% endfor %}
      </ul>
    </section>
    {% endif %}
  </div>
  
</body>
</html>
