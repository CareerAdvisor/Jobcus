{% extends "base.html" %}
{% block title %}Resume Builder – Jobcus{% endblock %}

{% block content %}
<main id="resume-builder" class="rb-wrap">
  <!-- Hero -->
  <div class="interview-container" style="padding:20px 10px;width:100%;background:#104879;">
    <section class="interview-hero-with-image" style="display:flex;flex-direction:column;align-items:center;text-align:center;">
      <h5 style="color:#ffc957;font-weight:600;font-size:14px;letter-spacing:1px;">AI RESUME BUILDER</h5>
      <h1 style="font-size:28px;font-weight:700;color:#fff;margin:10px 0;">Build a polished, ATS-friendly resume</h1>
      <p style="max-width:420px;color:#fff;font-size:16px;margin:10px 0 20px;">Use our modern or minimal template to build your resume.</p>
    </section>
  </div>

  <div class="rb-container">
    <form id="resumeForm" class="rb-form" autocomplete="on">

      <!-- Tabs (map each button to a step by id) -->
      <nav class="rb-tabs" role="tablist" aria-label="Resume builder steps">
        <button class="active" role="tab" aria-selected="true" data-target="#step-personal">Write</button>
        <button role="tab" aria-selected="false" data-target="#step-design">Design</button>
      </nav>

      <!-- STEP 1: Personal -->
      <div class="rb-section">
        <section id="step-personal" class="rb-step active" role="tabpanel" aria-labelledby="h-personal">
          <article class="rb-card">
            <header>
              <h2 id="h-personal">Personal details</h2>
              <p>Give recruiters a quick overview.</p>
            </header>

            <div class="rb-panel">
              <div class="rb-grid">
                <label>First name
                  <input type="text" name="firstName" placeholder="First name" required>
                </label>

                <label>Last name
                  <input type="text" name="lastName" placeholder="Last name" required>
                </label>

                <label>Job title
                  <input type="text" name="title" placeholder="Product Designer">
                </label>

              <details class="rb-disclosure" open style="margin-top:12px;">
                <summary><span class="twiddle">—</span> Hide additional details</summary>
                <div class="rb-grid" style="margin-top:.5rem;">
                  <label>Nationality <input type="text" name="nationality" placeholder="Britain"></label>
                  <label class="full">Birth date <input type="date" name="dob" placeholder="1996-02-03"></label>
                </div>
              </details>
            </div>
          </article>
        </section>
      </div>

      <!-- STEP 2: Contact -->
      <div class="rb-section">
        <section id="step-contact" class="rb-step" role="tabpanel" aria-labelledby="h-contact" hidden>
          <article class="rb-card">
            <header>
              <h2 id="h-contact">Contact information</h2>
              <p>Make it easy to reach you.</p>
            </header>
            <div class="rb-panel">
              <div class="rb-grid">
                <label class="full">Email <input type="email" name="email" placeholder="you@example.com" required></label>
                <label class="full">Phone <input type="tel" name="phone" placeholder="999 888 7777" required></label>
                <label>Country <input type="text" name="country" placeholder="USA"></label>
                <label>City <input type="text" name="city" placeholder="Austin"></label>
                <label class="full">Address <input type="text" name="address" placeholder="500 W 2nd St"></label>
                <label>Postcode <input type="text" name="postcode" placeholder="LN2 5TW"></label>
                <label class="full">LinkedIn / Portfolio <input type="url" name="portfolio" placeholder="https://linkedin.com/in/you"></label>
              </div>
            </div>
          </article>
        </section>
      </div>

      <!-- STEP 3: Summary -->
      <div class="rb-section">
        <section id="step-summary" class="rb-step" role="tabpanel" aria-labelledby="h-summary" hidden>
          <article class="rb-card">
            <header>
              <h2 id="h-summary">Professional Summary (with AI)</h2>
              <p>Include your title, years of experience and 1–2 measurable wins.</p>
            </header>
            <div class="rb-panel">
              <textarea name="summary" rows="5" placeholder="Product Designer with 10 years of experience..."></textarea>
              <div class="ai-suggest" id="ai-summary" data-field="summary">
                <div class="ai-title">✦ Write with AI</div>
                <p class="ai-text">We’ll fetch a tailored suggestion based on what you’ve entered so far…</p>
                <div class="ai-actions">
                  <button type="button" class="btn ai-refresh" data-ai="summary">Refresh</button>
                  <button type="button" class="btn btn-primary ai-add">Add</button>
                </div>
              </div>
            </div>
          </article>
        </section>
      </div>

      <!-- STEP 4: Experience -->
      <div class="rb-section">
        <section id="step-experience" class="rb-step" role="tabpanel" aria-labelledby="h-experience" hidden>
          <article class="rb-card" data-repeater="experience">
            <header>
              <h2 id="h-experience">Employment history (with AI highlights)</h2>
              <p>Use action verbs, quantify results, and keep it concise.</p>
            </header>

            <div class="rb-panel">
              <template id="tpl-experience">
                <div class="rb-item">
                  <div class="rb-grid">
                    <label class="full">Job title <input type="text" name="role" placeholder="Product Designer"></label>
                    <label class="full">Company name <input type="text" name="company" placeholder="Apple Inc."></label>
                    <label>Start date <input type="text" name="start" placeholder="Jan 2016"></label>
                    <label>End date <input type="text" name="end" placeholder="Feb 2019 / Present"></label>
                    <label class="full">Location <input type="text" name="location" placeholder="Washington, D.C."></label>
                  </div>

                  <label class="full" style="margin-top:12px;">Highlights (one per line)
                    <textarea name="bullets" rows="4" placeholder="• Reduced ticket backlog by 32%..."></textarea>
                  </label>

                  <div class="ai-suggest" data-field="bullets">
                    <div class="ai-title">✦ Write with AI</div>
                    <p class="ai-text">Get role-specific bullet ideas for this job.</p>
                    <div class="ai-actions">
                      <button type="button" class="btn ai-refresh" data-ai="highlights">Refresh</button>
                      <button type="button" class="btn btn-primary ai-add">Add</button>
                    </div>
                  </div>

                  <div class="rb-actions" style="padding-top:10px;">
                    <button type="button" class="rb-remove">Remove</button>
                  </div>
                </div>
              </template>

              <div class="rb-list" id="exp-list"></div>
              <button type="button" class="rb-add" data-add="experience">+ Add another experience</button>
            </div>
          </article>
        </section>
      </div>

      <!-- STEP 5: Skills -->
      <div class="rb-section">
        <section id="step-skills" class="rb-step" role="tabpanel" aria-labelledby="h-skills" hidden>
          <article class="rb-card">
            <header>
              <h2 id="h-skills">Skills</h2>
              <p>Highlight your most relevant professional skills.</p>
            </header>
            <div class="rb-panel">
              <div class="rb-chip-input">
                <input type="text" id="skillInput" placeholder="Type a skill and press Enter">
                <div id="skillChips" class="rb-chips" style="margin-top:8px;"></div>
                <input type="hidden" name="skills">
              </div>
            </div>
          </article>
        </section>
      </div>

      <!-- STEP 6: Education -->
      <div class="rb-section">
        <section id="step-education" class="rb-step" role="tabpanel" aria-labelledby="h-education" hidden>
          <article class="rb-card" data-repeater="education">
            <header>
              <h2 id="h-education">Education</h2>
              <p>Add your school, degree, dates and location.</p>
            </header>

            <div class="rb-panel">
              <template id="tpl-education">
                <div class="rb-item">
                  <div class="rb-grid">
                    <label class="full">Institution <input type="text" name="school" placeholder="University of Oxford"></label>
                    <label class="full">Degree <input type="text" name="degree" placeholder="Bachelor's Degree in Design"></label>
                    <label>Start date <input type="text" name="graduatedStart" placeholder="Jan 2016"></label>
                    <label>End date <input type="text" name="graduated" placeholder="Feb 2019"></label>
                    <label class="full">Location <input type="text" name="location" placeholder="Cambridge, MA"></label>
                  </div>
                  <div class="rb-actions" style="padding-top:10px;">
                    <button type="button" class="rb-remove">Remove</button>
                  </div>
                </div>
              </template>

              <div class="rb-list" id="edu-list"></div>
              <button type="button" class="rb-add" data-add="education">+ Add education</button>
            </div>
          </article>
        </section>
      </div>

      <!-- STEP 7: Design -->
      <div class="rb-section">
        <section id="step-design" class="rb-step" role="tabpanel" aria-labelledby="h-design" hidden>
          <article class="rb-card">
            <header><h2 id="h-design">Design</h2><p>Pick a template.</p></header>
            <div class="rb-panel">
              <label>Theme
                <select id="themeSelect" name="theme">
                  <option value="modern" selected>Modern</option>
                  <option value="minimal">Minimal</option>
                </select>
              </label>
              <div class="rb-row">
                <button type="button" id="previewTemplate" class="cta-secondary">Preview</button>
                <button type="button" id="downloadTemplatePdf" class="cta-primary">Download PDF</button>
              </div>
              <div id="resumePreviewWrap" style="display:none;margin-top:1rem;">
                <h3>Preview</h3>
                <iframe id="resumePreview" class="resume-preview" style="width:100%;height:100vh;border:0;background:#fff;"></iframe>
              </div>
            </div>
          </article>
        </section>
      </div>

      <!-- STEP 8: Finish -->
      <div class="rb-section">
        <section id="step-finish" class="rb-step" role="tabpanel" aria-labelledby="h-finish" hidden>
          <article class="rb-card">
            <header><h2 id="h-finish">All set!</h2><p>Preview or download your resume. You can always go back and edit.</p></header>
            <div class="rb-panel">
              <div class="rb-row">
                <button type="button" id="previewTemplateFinish" class="cta-secondary">Preview</button>
                <button type="button" id="downloadTemplatePdfFinish" class="cta-primary">Download PDF</button>
              </div>
              <div id="resumePreviewWrapFinish" style="display:none;margin-top:1rem;">
                <h3>Preview</h3>
                <iframe id="resumePreviewFinish" class="resume-preview" style="width:100%;height:90vh;border:0;background:#fff;"></iframe>
              </div>
            </div>
          </article>
        </section>
      </div>

      <!-- Sticky footer -->
      <footer class="rb-footer">
        <button type="button" id="rb-back" class="ghost">Back</button>
        <button type="button" id="rb-next" class="cta-secondary">Next</button>
        <button type="submit" id="rb-submit" class="cta-primary" style="display:none;">✨ Generate Resume</button>
      </footer>

      <!-- Hidden legacy containers -->
      <div id="builderGeneratingIndicator" style="display:none;">🤖 Generating your resume…</div>
      <div id="builderGeneratedContent" hidden></div>
      <div id="resumeDownloadOptions" hidden></div>
    </form>
  </div>
</main>
{% endblock %}

{% block scripts %}

  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
/* ==== Resume Builder (scoped) ==== */
#resume-builder {
  --brand:#104879;
  --accent:#ffc957;
  --bg:#f5f7fb;
  --card:#fff;
  --muted:#6b7280;
  --border:#e5e7eb;
  --radius:14px;
}

/* Wrap + container */
#resume-builder.rb-wrap { background: var(--bg); padding: 1rem; }
#resume-builder .rb-container { max-width: 940px; margin: 0 auto; padding: 0 12px 24px; }

/* Tabs */
#resume-builder .rb-tabs{
  position:sticky; top:0; z-index:10;
  display:flex; gap:.5rem; padding:.5rem .75rem;
  backdrop-filter:saturate(180%) blur(8px);
  background:linear-gradient(#fff8, #fff8), var(--bg);
  border-bottom:1px solid var(--border);
}
#resume-builder .rb-tabs button{
  flex:0 0 auto; border:0; padding:.55rem .9rem; border-radius:999px;
  background:#eef2f7; font-weight:600;
}
#resume-builder .rb-tabs button.active{ background:var(--brand); color:#fff; }

/* Cards */
#resume-builder .rb-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:0;
  margin:0 0 1rem;
  box-shadow:0 4px 14px rgba(16,72,121,.06);
}
#resume-builder .rb-card > header{
  padding:18px 18px 14px;
  border-bottom:1px solid #eef2f7;
}
#resume-builder .rb-card > header h2{
  margin:0 0 .4rem;
  font-size:1.1rem;        /* smaller, tidy */
  font-weight:700;
}
#resume-builder .rb-card > header p{
  margin:0;
  font-size:.9rem;
  color:var(--muted);
  line-height:1.35;
}

/* Inner panel */
#resume-builder .rb-panel{
  margin:12px;
  padding:14px;
  border:1px solid #eef2f7;
  background:#f8fbff;
  border-radius:14px;
}

/* Grid */
#resume-builder .rb-grid{ display:grid; gap:.9rem; grid-template-columns:1fr 1fr; }
#resume-builder .rb-grid .full{ grid-column:1/-1; }
@media (max-width:640px){ #resume-builder .rb-grid{ grid-template-columns:1fr; } }

/* Labels & fields */
#resume-builder label{ display:flex; flex-direction:column; gap:.35rem; font-weight:600; font-size:.9rem; }
#resume-builder .rb-panel input,
#resume-builder .rb-panel select,
#resume-builder .rb-panel textarea{
  border:1px solid var(--border);
  border-radius:10px;
  padding:.85rem .9rem;
  font:inherit;
  font-size:.9rem;               /* smaller field text */
  background:#fff;
}
#resume-builder .rb-panel input::placeholder,
#resume-builder .rb-panel textarea::placeholder{
  font-size:.85rem;
  color:var(--muted);
}
#resume-builder textarea{ resize:vertical; }

/* Disclosure */
#resume-builder .rb-disclosure summary{
  background:#f3f4f6;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:12px 14px;
  font-weight:700;
  cursor:pointer;
}
#resume-builder .rb-disclosure[open] summary{ background:#eef2f7; }

/* Repeater items */
#resume-builder .rb-item{ border:1px dashed var(--border); border-radius:12px; padding:.75rem; margin:.6rem 0; background:#fafbff; }
#resume-builder .rb-actions{ display:flex; justify-content:flex-end; }
#resume-builder .rb-remove{ background:#fff; border:1px solid var(--border); padding:.5rem .75rem; border-radius:8px; }
#resume-builder .rb-add{ margin-top:.25rem; border:1px dashed var(--border); background:#fff; padding:.6rem .8rem; border-radius:999px; }

/* Chips */
#resume-builder .rb-chips{ display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.5rem; }
#resume-builder .rb-chips .chip{ padding:.35rem .6rem; border-radius:999px; border:1px solid var(--border); background:#f6f8fb; }
#resume-builder .rb-chip-input{ display:flex; flex-direction:column; }

/* Steps visibility */
#resume-builder .rb-step{ display:none; }
#resume-builder .rb-step.active{ display:block; }

/* Footer nav */
#resume-builder .rb-footer{
  position:sticky; bottom:0; display:flex; gap:.5rem;
  justify-content:space-between; align-items:center; padding:.6rem;
  background:#fff; border-top:1px solid var(--border);
  border-start-start-radius:12px; border-start-end-radius:12px; margin-top:1rem;
}
#resume-builder .cta-primary{ background:var(--accent); color:#1f2a37; border:0; padding:.7rem 1rem; border-radius:10px; font-weight:700; }
#resume-builder .cta-secondary{ background:var(--brand); color:#fff; border:0; padding:.7rem 1rem; border-radius:10px; font-weight:700; }
#resume-builder .ghost{ background:#fff; border:1px solid var(--border); padding:.7rem 1rem; border-radius:10px; }

/* Photo upload */
#resume-builder .photo-upload{
  display:flex; align-items:center; gap:10px;
  border:1px solid #e5e7eb; background:#f8fafc;
  border-radius:12px; padding:10px 12px; height:48px;
}
#resume-builder .photo-btn{ border:0; background:#fff; width:40px; height:40px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.06); cursor:pointer; display:inline-grid; place-items:center; }
#resume-builder .photo-label{ font-weight:600; color:#111827; }
#resume-builder #photoPreview{ width:40px; height:40px; border-radius:10px; object-fit:cover; }

/* AI suggest */
#resume-builder .ai-suggest {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  background: #fffef8;
  box-shadow: 0 2px 6px rgba(0,0,0,0.03);
  margin-top: 12px;
}
#resume-builder .ai-title { font-weight:700; font-size:.95rem; margin-bottom:4px; color:var(--brand); }
#resume-builder .ai-text  { font-size:.9rem;  color:var(--muted); margin-bottom:8px; }
#resume-builder .ai-actions{ display:flex; gap:8px; }
#resume-builder .ai-actions .btn{ border:1px solid var(--border); border-radius:8px; background:#fff; padding:6px 10px; font-size:.85rem; cursor:pointer; }
#resume-builder .ai-actions .btn-primary{ background:var(--brand); color:#fff; border:none; }

/* Section wrapper (outer spacing) */
#resume-builder .rb-section{ margin:16px 0 24px; }

/* Hero → form separation (this page only) */
#resume-builder .interview-container{ margin-bottom:24px; }
  </script>
    // Ensure fetch keeps cookies
(function () {
  const _fetch = window.fetch.bind(window);
  window.fetch = (input, init = {}) => {
    if (!("credentials" in init)) init.credentials = "same-origin";
    return _fetch(input, init);
  };
})();

function qs(root, sel)  { return (root || document).querySelector(sel); }
function qsa(root, sel) { return Array.from((root || document).querySelectorAll(sel)); }
function withinBuilder(sel){ return `#resume-builder ${sel}`; }

// Debounce
function debounce(fn, wait = 400){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

const AI_ENDPOINT = "/ai/suggest";

function gatherContext(form) {
  const builder = qs(document, "#resume-builder");
  const name = [form.firstName?.value, form.lastName?.value].filter(Boolean).join(" ").trim();
  const contactParts = [];
  const loc = [form.city?.value, form.country?.value].filter(Boolean).join(", ");
  if (loc) contactParts.push(loc);
  if (form.phone?.value) contactParts.push(form.phone.value);
  if (form.email?.value) contactParts.push(form.email.value);

  const expNodes = qsa(builder, "#exp-list .rb-item");
  const experience = expNodes.map((node) => {
    const g = (n) => qs(node, `[name="${n}"]`);
    const bullets = (g("bullets").value || "")
      .split("\n").map(t => t.replace(/^•\s*/, "").trim()).filter(Boolean);
    return {
      role: g("role").value, company: g("company").value, location: g("location").value,
      start: g("start").value, end: g("end").value, bullets
    };
  });

  const eduNodes = qsa(builder, "#edu-list .rb-item");
  const education = eduNodes.map((node) => {
    const g = (n) => qs(node, `[name="${n}"]`);
    return {
      degree: g("degree").value, school: g("school").value,
      location: g("location").value,
      graduated: g("graduated").value || g("graduatedStart").value
    };
  });

  const skills = (form.elements["skills"]?.value || "").split(",").map(s => s.trim()).filter(Boolean);

  return {
    name,
    title: form.title?.value.trim() || "",
    contact: contactParts.join(" | "),
    summary: form.summary?.value.trim() || "",
    links: form.portfolio?.value ? [{ url: form.portfolio.value, label: "Portfolio" }] : [],
    experience, education, skills
  };
}

async function aiSuggest(field, ctx, index) {
  try {
    const res = await fetch(AI_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ field, index, context: ctx }),
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok || json.error) throw new Error(json.error || `AI suggest failed for ${field}`);
    return json;
  } catch (e) {
    console.warn(e);
    return { text: "AI suggestion currently unavailable. Try again." };
  }
}

function attachAISuggestionHandlers() {
  const builder = qs(document, "#resume-builder");
  builder.addEventListener("click", async (e) => {
    const btn = e.target.closest(".ai-refresh, .ai-add");
    if (!btn) return;

    const card = btn.closest(".ai-suggest");
    const form = qs(builder, "#resumeForm");

    if (btn.classList.contains("ai-refresh")) {
      const field = btn.dataset.ai;
      const ctx = gatherContext(form);

      if (field === "summary") {
        const sug = await aiSuggest("summary", ctx);
        const p = qs(card, ".ai-text");
        p.textContent = sug.text || p.textContent;
      } else if (field === "highlights") {
        const all = qsa(builder, "#exp-list .rb-item");
        const idx = all.findIndex((n) => n.contains(card));
        const sug = await aiSuggest("highlights", ctx, idx);
        const p = qs(card, ".ai-text");
        p.textContent = Array.isArray(sug.list) && sug.list.length
          ? sug.list.map((b) => `• ${b}`).join("\n")
          : (sug.text || p.textContent);
      }
      return;
    }

    if (btn.classList.contains("ai-add")) {
      const step = btn.closest(".rb-step");
      const cardWrap = btn.closest(".rb-card, .rb-item");
      const suggestion = qs(card, ".ai-text")?.textContent?.trim() || "";
      if (!suggestion) return;

      let ta = null;
      if (card.dataset.field === "summary") ta = qs(step, 'textarea[name="summary"]');
      else if (card.dataset.field === "bullets") ta = qs(cardWrap, 'textarea[name="bullets"]');
      if (!ta) ta = qs(cardWrap, "textarea");
      if (!ta) return;

      if (ta.name === "bullets") {
        const prefix = ta.value && !ta.value.endsWith("\n") ? "\n" : "";
        const cleaned = suggestion.split("\n").map(s => s.replace(/^•\s*/, "").trim()).filter(Boolean);
        ta.value += `${prefix}${cleaned.map(b => `• ${b}`).join("\n")}`;
      } else {
        ta.value = suggestion.replace(/^•\s*/g, "");
      }
      ta.dispatchEvent(new Event("input", { bubbles: true }));
    }
  });
}

// Repeaters
function cloneFromTemplate(tplId) {
  const tpl = qs(document, withinBuilder(`#${tplId}`));
  if (!tpl) return null;
  const node = tpl.content.firstElementChild.cloneNode(true);
  qs(node, ".rb-remove")?.addEventListener("click", () => node.remove());
  setTimeout(() => { qs(node, ".ai-suggest .ai-refresh")?.click(); }, 0);
  return node;
}
function addExperienceFromObj(obj = {}) {
  const list = qs(document, withinBuilder("#exp-list"));
  const node = cloneFromTemplate("tpl-experience");
  if (!node || !list) return;
  const g = (n) => qs(node, `[name="${n}"]`);
  g("role").value = obj.role || "";
  g("company").value = obj.company || "";
  g("start").value = obj.start || "";
  g("end").value = obj.end || "";
  g("location").value = obj.location || "";
  g("bullets").value = (obj.bullets || []).join("\n");
  list.appendChild(node);
}
function addEducationFromObj(obj = {}) {
  const list = qs(document, withinBuilder("#edu-list"));
  const node = cloneFromTemplate("tpl-education");
  if (!node || !list) return;
  const g = (n) => qs(node, `[name="${n}"]`);
  g("school").value = obj.school || "";
  g("degree").value = obj.degree || "";
  g("graduatedStart").value = obj.graduatedStart || "";
  g("graduated").value = obj.graduated || "";
  g("location").value = obj.location || "";
  list.appendChild(node);
}

// Skills chips
function initSkills() {
  const builder = qs(document, "#resume-builder");
  const skillInput = qs(builder, "#skillInput");
  const skillChips = qs(builder, "#skillChips");
  const skillsHidden = qs(builder, 'input[name="skills"]');
  const skillsSet = new Set();

  function refreshChips() {
    if (!skillChips || !skillsHidden) return;
    skillChips.innerHTML = "";
    skillsHidden.value = Array.from(skillsSet).join(",");
    skillsSet.forEach((s) => {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `${s} <button type="button" aria-label="Remove">×</button>`;
      chip.querySelector("button").onclick = () => { skillsSet.delete(s); refreshChips(); };
      skillChips.appendChild(chip);
    });
  }

  skillInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && skillInput.value.trim()) {
      e.preventDefault();
      skillsSet.add(skillInput.value.trim());
      skillInput.value = "";
      refreshChips();
    }
  });

  return { refreshChips, skillsSet };
}

// Server render helpers (unchanged)
async function renderWithTemplateFromContext(ctx, format = "html", theme = "modern") {
  if (format === "pdf") {
    const res = await fetch("/build-resume", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ format: "pdf", theme, ...ctx }),
    });
    if (!res.ok) throw new Error(`PDF build failed: ${res.status}`);
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "resume.pdf"; a.click();
    URL.revokeObjectURL(url);
    return;
  }
  const r = await fetch("/build-resume", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ format: "html", theme, ...ctx }),
  });
  const html = await r.text();
  if (!r.ok) throw new Error(`HTML build failed: ${r.status} ${html}`);
  const wrap  = qs(document, withinBuilder("#resumePreviewWrap, #resumePreviewWrapFinish"));
  const frame = qs(document, withinBuilder("#resumePreview, #resumePreviewFinish"));
  if (wrap && frame) { wrap.style.display = "block"; frame.srcdoc = html; }
}

function initWizard() {
  const builder = qs(document, "#resume-builder");
  const form = qs(builder, "#resumeForm");

  const steps = [
    "#step-personal",
    "#step-contact",
    "#step-summary",
    "#step-experience",
    "#step-skills",
    "#step-education",
    "#step-design",
    "#step-finish",
  ].map(sel => qs(builder, sel));

  const tabs = qsa(builder, ".rb-tabs button");
  const back = qs(builder, "#rb-back");
  const next = qs(builder, "#rb-next");
  const submitBtn = qs(builder, "#rb-submit");
  let idx = 0;

  function stepIndexById(id){ return steps.findIndex(s => s && ("#" + s.id) === id); }

  function updateButtons() {
    if (back) back.disabled = idx === 0;
    if (next) next.style.display = idx >= steps.length - 2 ? "none" : "inline-block";
    if (submitBtn) submitBtn.style.display = (idx === steps.length - 2) ? "inline-block" : "none";
  }

  async function onEnterStep(i) {
    const node = steps[i]; if (!node) return;
    if (node.id === "step-summary" && !node.dataset.loaded) {
      node.dataset.loaded = "1";
      qs(node, "#ai-summary .ai-refresh")?.click();
    }
    if (node.id === "step-experience" && !qs(builder, "#exp-list .rb-item")) addExperienceFromObj();
    if (node.id === "step-education" && !qs(builder, "#edu-list .rb-item")) addEducationFromObj();
    if (node.id === "step-experience" && !node.dataset.loaded) {
      node.dataset.loaded = "1";
      qsa(builder, "#exp-list .ai-suggest .ai-refresh").forEach(btn => btn.click());
    }
  }

  function showStep(i) {
    idx = Math.max(0, Math.min(i, steps.length - 1));
    steps.forEach((s, k) => {
      if (!s) return;
      const active = k === idx;
      s.hidden = !active;
      s.classList.toggle("active", active);
    });
    // Sync tab active state to the current step (based on data-target)
    tabs.forEach(btn => {
      const tId = btn.getAttribute("data-target");
      const isActive = tId && steps[idx] && ("#" + steps[idx].id) === tId;
      btn.classList.toggle("active", !!isActive);
      btn.setAttribute("aria-selected", isActive ? "true" : "false");
    });

    window.scrollTo({ top: 0, behavior: "smooth" });
    updateButtons();
    onEnterStep(idx);
  }

  // Tab clicks: jump to their mapped step
  tabs.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      const i = stepIndexById(target);
      if (i >= 0) showStep(i);
    });
  });

  back?.addEventListener("click", () => showStep(idx - 1));
  next?.addEventListener("click", () => showStep(idx + 1));

  // Add buttons (experience/education)
  builder.addEventListener("click", (e) => {
    const addBtn = e.target.closest("[data-add]");
    if (!addBtn) return;
    const type = addBtn.getAttribute("data-add");
    if (type === "experience") addExperienceFromObj();
    if (type === "education") addEducationFromObj();
  });

  // Photo upload
  qs(builder, "#photoBtn")?.addEventListener("click", () => qs(builder, "#photoInput")?.click());
  qs(builder, "#photoInput")?.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    const img = qs(builder, "#photoPreview");
    if (file && img) {
      const url = URL.createObjectURL(file);
      img.src = url; img.hidden = false;
    }
  });

  // Submit → generate, then go to Finish
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      qs(builder, "#builderGeneratingIndicator").style.display = "block";
      const ctxForTemplate = gatherContext(form);

      const educationStr = (ctxForTemplate.education || [])
        .map(ed => [ed.degree, ed.school, ed.location, ed.graduated].filter(Boolean).join(" – "))
        .join("\n");
      const experienceStr = (ctxForTemplate.experience || [])
        .map(e => `${e.role}${e.company ? " – " + e.company : ""}\n${(e.bullets || []).map(b => "• " + b).join("\n")}`)
        .join("\n\n");
      const payload = {
        fullName: ctxForTemplate.name || "",
        title: ctxForTemplate.title || "",
        contact: ctxForTemplate.contact || "",
        summary: ctxForTemplate.summary || "",
        education: educationStr,
        experience: experienceStr,
        skills: (ctxForTemplate.skills || []).join(", "),
        certifications: form.elements["certifications"]?.value?.trim() || "",
        portfolio: (ctxForTemplate.links?.[0]?.url) || "",
      };

      const gen = await fetch("/generate-resume", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const genJson = await gen.json().catch(() => ({}));
      if (!gen.ok || genJson.error) throw new Error(genJson.error || "Generate failed");

      window._resumeCtx = genJson.context || ctxForTemplate;
      showStep(stepIndexById("#step-finish"));
    } catch (err) {
      console.error("Generate/build error:", err);
      alert("Resume generation failed.");
    } finally {
      qs(builder, "#builderGeneratingIndicator").style.display = "none";
    }
  });

  // Preview / PDF (Design + Finish)
  const previewBtn  = qs(builder, "#previewTemplate");
  const pdfBtn      = qs(builder, "#downloadTemplatePdf");
  const themeSelect = qs(builder, "#themeSelect");

  previewBtn?.addEventListener("click", async () => {
    try {
      qs(builder, "#builderGeneratingIndicator").style.display = "block";
      const ctx = window._resumeCtx || gatherContext(qs(builder, "#resumeForm"));
      await renderWithTemplateFromContext(ctx, "html", themeSelect?.value || "modern");
    } catch (e) { console.error(e); alert(e.message || "Preview failed"); }
    finally { qs(builder, "#builderGeneratingIndicator").style.display = "none"; }
  });

  pdfBtn?.addEventListener("click", async () => {
    try {
      qs(builder, "#builderGeneratingIndicator").style.display = "block";
      const ctx = window._resumeCtx || gatherContext(qs(builder, "#resumeForm"));
      await renderWithTemplateFromContext(ctx, "pdf", themeSelect?.value || "modern");
    } catch (e) { console.error(e); alert(e.message || "PDF build failed"); }
    finally { qs(builder, "#builderGeneratingIndicator").style.display = "none"; }
  });

  qs(builder, "#previewTemplateFinish")?.addEventListener("click", () => previewBtn?.click());
  qs(builder, "#downloadTemplatePdfFinish")?.addEventListener("click", () => pdfBtn?.click());

  // Start
  showStep(0);
}

async function maybePrefillFromAnalyzer(form, helpers) {
  const raw = localStorage.getItem("resumeTextRaw");
  if (!raw || !form) return;
  const builder = qs(document, "#resume-builder");
  const isEmpty = !(form.firstName?.value || form.lastName?.value || form.title?.value || form.summary?.value) &&
                  !qs(builder, "#exp-list .rb-item input[value]");
  if (!isEmpty) return;

  try {
    const gen = await fetch("/generate-resume", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fullName:"", title:"", contact:"", summary: raw, education:"", experience: raw, skills:"", certifications:"", portfolio:"" }),
    });
    const genJson = await gen.json().catch(() => ({}));
    if (!gen.ok || genJson.error) throw new Error(genJson.error || "Generate failed");

    const ctx = genJson.context || {};
    const name = (ctx.name || "").trim().split(" ");
    if (form.firstName) form.firstName.value = name.shift() || "";
    if (form.lastName)  form.lastName.value  = name.join(" ");
    if (form.title)   form.title.value   = ctx.title || "";
    if (form.summary) form.summary.value = ctx.summary || "";
    if (ctx.links && ctx.links[0] && form.portfolio) form.portfolio.value = ctx.links[0].url || "";

    if (Array.isArray(ctx.skills) && ctx.skil
        </script>
{% endblock %}
