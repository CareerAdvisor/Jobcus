{# templates/cover-letter.html #}
{% extends "base.html" %}
{% block title %}Cover Letter – Jobcus{% endblock %}

{% set is_paid  = current_user.is_authenticated and (current_user.plan|lower in ['standard','premium']) %}
{% set wm_text  = '' if is_paid else 'JOBCUS.COM' %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/cover-letter.css') }}">
{% endblock %}

{% block content %}
<main id="cover-letter" class="rb-wrap">

  <!-- Hero (matches your original look) -->
  <section class="cl-hero">
    <div class="cl-hero-card">
      <div class="cl-hero-eyebrow">AI COVER LETTER</div>
      <h1 class="cl-hero-title">
        Create a tailored <span>cover</span> letter
      </h1>
      <p class="cl-hero-subtitle">
        Use your resume details to draft a polished letter.
      </p>
    </div>
  </section>

  <!-- Layout: form + sticky preview -->
  <div class="rb-container rb-layout">

    <!-- Left: Form (2-step wizard) -->
    <div class="rb-main">
      <form id="clForm" class="rb-form" autocomplete="on">
        <!-- Step 1: Recruiter -->
        <section class="rb-step active" id="step-recruiter">
          <article class="rb-card">
            <header class="stacked-hero">
              <h2>Recruiter</h2>
              <p>Company, role, job link, tone, and recipient details.</p>
            </header>
            <div class="rb-panel">
              <div class="rb-grid">
                <label>Company
                  <input type="text" name="company" placeholder="Acme Inc.">
                </label>
                <label>Role
                  <input type="text" name="role" placeholder="IT Support">
                </label>
                <label class="full">Job link (optional)
                  <input type="url" name="jobUrl" placeholder="https://…">
                </label>
                <label class="full">Tone
                  <select name="tone">
                    <option value="professional" selected>Professional</option>
                    <option value="friendly">Friendly</option>
                    <option value="concise">Concise</option>
                  </select>
                </label>

                <label class="full">Recipient (Name or Team)
                  <input type="text" name="recipient" placeholder="Hiring Manager">
                </label>

                <div class="full rb-minihead">Recipient’s address</div>
                <label class="full">Company address (line 1)
                  <input type="text" name="companyAddress1" placeholder="45 Market Road">
                </label>
                <label>City
                  <input type="text" name="companyCity" placeholder="London">
                </label>
                <label>Postcode
                  <input type="text" name="companyPostcode" placeholder="W1 2BC">
                </label>
              </div>
            </div>
          </article>
        </section>

        <!-- Step 2: Applicant -->
        <section class="rb-step" id="step-applicant">
          <article class="rb-card">
            <header class="stacked-hero">
              <h2>Applicant</h2>
              <p>Your contact details for the letter heading.</p>
            </header>
            <div class="rb-panel">
              <div class="rb-grid">
                <label>First name <input type="text" name="firstName" placeholder="John"></label>
                <label>Last name  <input type="text" name="lastName"  placeholder="Doe"></label>
                <label class="full">Your address (line 1)
                  <input type="text" name="senderAddress1" placeholder="123 High Street">
                </label>
                <label>City
                  <input type="text" name="senderCity" placeholder="London">
                </label>
                <label>Postcode
                  <input type="text" name="senderPostcode" placeholder="E1 1AA">
                </label>
                <label>Email
                  <input type="email" name="senderEmail" placeholder="you@email.com">
                </label>
                <label>Phone
                  <input type="tel" name="senderPhone" placeholder="+44 7123 456 789">
                </label>
                <label>Date
                  <input type="date" name="letterDate">
                </label>

                <label class="full">Letter body
                  <textarea name="body" rows="10" placeholder="Write or generate your letter body here…"></textarea>
                </label>

                <!-- AI assistant -->
                <div class="ai-suggest" id="ai-cl" data-field="cover_letter">
                  <div class="ai-title">✦ Write with AI</div>
                  <p class="ai-text">We’ll draft a tailored letter using your details above.</p>
                  <div class="ai-actions">
                    <button type="button" class="btn ai-refresh" data-ai="cover_letter">Refresh</button>
                    <button type="button" class="btn btn-primary ai-add">Insert</button>
                  </div>
                </div>

              </div>
            </div>
          </article>
        </section>

        <!-- Wizard controls -->
        <footer class="rb-footer">
          <button type="button" id="rb-back"  class="ghost">← Back</button>
          <div class="rb-actions">
            <button type="button" id="rb-next" class="cta-primary">Next</button>
          </div>
        </footer>
      </form>
    </div>

    <!-- Right: Sticky Preview -->
    <aside class="rb-preview">
      <article class="rb-card">
        <div class="rb-panel">
          <div class="rb-actions">
            <button type="button" id="cl-preview" class="cta-secondary">Preview</button>
            <button type="button" id="cl-download-pdf"  class="cta-primary">Download PDF</button>
            <button type="button" id="cl-download-docx" class="cta-primary alt">Download Word</button>
          </div>

          <div id="clPreviewWrap" class="preview-wrap" style="display:none;"
               {% if wm_text %} data-watermark="{{ wm_text }}"{% endif %}>
            <iframe id="clPreview" title="Cover Letter Preview"></iframe>
          </div>
        </div>
      </article>
    </aside>

  </div>
</main>
{% endblock %}

{% block scripts %}
  <!-- DOCX fallback (for client-side Word download if server route missing) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.7.0/docx.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script defer src="{{ url_for('static', filename='js/cover-letter.js') }}"></script>
{% endblock %}
