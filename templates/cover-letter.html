{# templates/cover-letter.html #}
{% extends "base.html" %}
{% block title %}Cover Letter – Jobcus{% endblock %}

{% set is_paid  = current_user.is_authenticated and (current_user.plan|lower in ['standard','premium']) %}
{% set wm_text  = '' if is_paid else 'JOBCUS.COM' %}

{% block content %}

{# ---------- LETTER-ONLY (iframe preview / PDF) ---------- #}
{% if letter_only %}
  <style>
    /* Hide site chrome for clean letter-only render */
    header, nav, footer,
    .site-header, .site-footer, .navbar, .topbar, .app-footer,
    .chat-widget, .floating-chat, .intercom-lightweight-app { display:none !important; }

    html, body { background:#fff; margin:0; -webkit-text-size-adjust:100%; text-size-adjust:100%; }

    /* Screen + print use 12pt to match requirement */
    .cl {
      max-width: clamp(680px, 84vw, 860px);
      margin: 36px auto;
      padding: 0 16px;
      color:#111;
      font: 12pt/1.55 Arial, Helvetica, sans-serif;
    }

    .cl-header { text-align:center; margin: 0 auto 14pt; }
    .cl-header .name { font-weight:800; font-size:32pt; line-height:1.1; margin:0; } /* big name */
    .cl-header .contact { margin-top:6pt; color:#555; }
    .cl-header .contact .line { margin:2pt 0; }

    .date       { margin: 12pt 0 14pt; color:#555; }
    .recipient  { margin: 0 0 12pt; }
    .salutation { margin: 0 0 10pt; }
    .block      { white-space:pre-wrap; overflow-wrap:anywhere; }

    @page  { size:A4; margin:18mm 18mm; }
  </style>

  <div class="cl">
    <!-- Header: Name → one-line address → email/phone -->
    <div class="cl-header">
      {% if sender.name %}<div class="name">{{ sender.name }}</div>{% endif %}
      <div class="contact">
        {% if sender.address1 or sender.city or sender.postcode %}
          <div class="line">
            {% if sender.address1 %}{{ sender.address1 }}{% endif %}
            {% if sender.city %}{% if sender.address1 %}, {% endif %}{{ sender.city }}{% endif %}
            {% if sender.postcode %}{% if sender.address1 or sender.city %}, {% endif %}{{ sender.postcode }}{% endif %}
          </div>
        {% endif %}
        {% if sender.email or sender.phone %}
          <div class="line">
            {% if sender.email %}{{ sender.email }}{% endif %}
            {% if sender.email and sender.phone %} | {% endif %}
            {% if sender.phone %}{{ sender.phone }}{% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    {% if sender.date %}<div class="date">{{ sender.date }}</div>{% endif %}

    {% if recipient.name or recipient.company or recipient.address1 or recipient.city or recipient.postcode %}
      <div class="recipient">
        {% if recipient.name %}<div>{{ recipient.name }}</div>{% endif %}
        {% if recipient.company %}<div>{{ recipient.company }}</div>{% endif %}
        {% if recipient.address1 %}<div>{{ recipient.address1 }}</div>{% endif %}
        {% if recipient.city or recipient.postcode %}
          <div>{{ recipient.city }}{% if recipient.city and recipient.postcode %}, {% endif %}{{ recipient.postcode }}</div>
        {% endif %}
      </div>
    {% endif %}

    <div class="salutation">Dear {{ recipient.name or 'Hiring Manager' }},</div>
    <main class="block">{{ cover_body or draft or '' }}</main>

    <div style="margin-top:12pt;">Yours sincerely,</div>
    <div>{{ sender.name or '' }}</div>
  </div>

{# ---------- BUILDER PAGE ---------- #}
{% else %}
  <main id="cover-letter" class="rb-wrap">
    <!-- Desktop-only overrides for a wider preview experience -->
    <style>
      /* Wider container on large screens so the preview isn’t visually clipped */
      @media (min-width: 1024px) {
        .rb-container.rb-layout { max-width: 1300px; }
        .rb-preview { max-width: none; }
        #clPreviewWrap { max-width: none; }
        #clPreview {
          width: min(100%, 900px);  /* ~A4 width at typical CSS px */
          height: 90vh;
          margin: 0 auto;
          display: block;
          border: 0;
          background: #fff;
        }
      }

      /* Golden yellow refresh button with high-contrast text */
      .ai-suggest .ai-refresh {
        background: #ffc957;
        border: 1px solid #ffc957;
        color: #104879;
      }
      .ai-suggest .ai-refresh:hover { filter: brightness(0.95); }
      .ai-suggest .ai-refresh:focus { outline: 2px solid #104879; outline-offset: 2px; }
    </style>

    <!-- Hero -->
    <div class="interview-container" style="padding:20px 16px;width:100%;background:#104879;">
      <section class="interview-hero-with-image" style="display:flex;flex-direction:column;align-items:center;text-align:center;">
        <h5 style="color:#ffc957;font-weight:600;font-size:14px;letter-spacing:1px;">AI COVER LETTER</h5>
        <h1 style="font-size:28px;font-weight:700;color:#fff;margin:10px 0;">Create a tailored <span style="color:#ffc957;">cover letter</span>
</h1>
        <p style="max-width:520px;color:#fff;font-size:16px;margin:10px 0 20px;">Use your resume details to draft a polished letter.</p>
      </section>
    </div>

    <div class="rb-container rb-layout" style="margin-top:16px; dashed #e5e7ee;border-radius:10px; box-shadow: 0 2px 6px rgba(0,0,0,.08); background:#f8fcff;">
      <!-- Left: Form -->
      <div class="rb-main">
        <form id="clForm" class="rb-form" autocomplete="on">

          <!-- Recruiter section -->
          <div class="rb-section">
            <section class="rb-step active">
              <article class="rb-card">
                <header style="height: 90px; color:#104879; font-size: 20px;">
                  <h2>Recruiter</h2>
                  <p>Company, role, job link, tone, and recipient details.</p>
                </header></br>
                <div class="rb-panel">
                  <div class="rb-grid">
                    <label>Company
                      <input type="text" name="company" placeholder="Acme Inc.">
                    </label>
                    <label>Role
                      <input type="text" name="role" placeholder="IT Support">
                    </label>
                    <label class="full">Job link (optional)
                      <input type="url" name="jobUrl" placeholder="https://…">
                    </label>
                    <label class="full">Tone
                      <select name="tone">
                        <option value="professional" selected>Professional</option>
                        <option value="friendly">Friendly</option>
                        <option value="concise">Concise</option>
                      </select>
                    </label>

                    <label class="full">Recipient (Name or Team)
                      <input type="text" name="recipient" placeholder="Hiring Manager">
                    </label>

                    <div class="full" style="margin-top:6px;font-weight:600;color:#104879;">Recipient’s address</div>
                    <label class="full">Company address (line 1)
                      <input type="text" name="companyAddress1" placeholder="45 Market Road">
                    </label>
                    <label>City
                      <input type="text" name="companyCity" placeholder="London">
                    </label>
                    <label>Postcode
                      <input type="text" name="companyPostcode" placeholder="W1 2BC">
                    </label>
                  </div>
                </div>
              </article>
            </section>
          </div></br>

          <!-- Applicant section -->
          <div class="rb-section">
            <section class="rb-step">
              <article class="rb-card">
                <header style="height: 90px; color:#104879; font-size: 20px;">
                  <h2>Applicant</h2>
                  <p>Your contact details for the letter heading.</p>
                </header></br>
                <div class="rb-panel">
                  <div class="rb-grid">
                    <label>First name <input type="text" name="firstName" placeholder="John"></label>
                    <label>Last name  <input type="text" name="lastName"  placeholder="Doe"></label>
                    <label class="full">Your address (line 1)
                      <input type="text" name="senderAddress1" placeholder="123 High Street">
                    </label>
                    <label>City
                      <input type="text" name="senderCity" placeholder="London">
                    </label>
                    <label>Postcode
                      <input type="text" name="senderPostcode" placeholder="E1 1AA">
                    </label>
                    <label>Email
                      <input type="email" name="senderEmail" placeholder="you@email.com">
                    </label>
                    <label>Phone
                      <input type="tel" name="senderPhone" placeholder="+44 7123 456 789">
                    </label>
                    <label>Date
                      <input type="date" name="letterDate">
                    </label>
                  </div>
                </div>
              </article>
            </section>
          </div></br>

          <!-- Body -->
          <div class="rb-section">
            <section class="rb-step">
              <article class="rb-card">
                <div class="rb-panel">
                  <textarea name="body" rows="12" placeholder="Write or generate your letter body here…"></textarea>

                  <div class="ai-suggest" id="ai-cl" data-field="cover_letter">
                    <div class="ai-title">✦ Write with AI</div>
                    <p class="ai-text">We’ll draft a tailored letter using your details above.</p>
                    <div class="ai-actions">
                      <button type="button" class="btn ai-refresh" data-ai="cover_letter">Refresh</button>
                      <button type="button" class="btn btn-primary ai-add">Insert</button>
                    </div>
                  </div>
                </div>
              </article>
            </section>
          </div>

          <footer class="rb-footer">
            <a class="ghost" href="/resume-builder">← Back to Builder</a>
          </footer>
        </form>
      </div>

      <!-- Right: Sticky Preview -->
      <aside class="rb-preview">
        <article class="rb-card">
          <div class="rb-panel">
            <div class="rb-actions">
              <button type="button" id="cl-preview" class="cta-secondary">Preview</button>
              <button type="button" id="cl-download" class="cta-primary">Download PDF</button>
            </div>
            <div id="clPreviewWrap" class="preview-wrap" style="display:none;"
                 {% if wm_text %} data-watermark="{{ wm_text }}"{% endif %}>
              <iframe id="clPreview" style="width:100%; height:80vh; border:0; background:#fff;"></iframe>
            </div>
          </div>
        </article>
      </aside>
    </div>
  </main>
{% endif %}
{% endblock %}

{% block scripts %}
  {% if not letter_only %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cover-letter.css') }}">
    <script defer src="{{ url_for('static', filename='js/cover-letter.js') }}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const wrap  = document.getElementById("clPreviewWrap");
        const frame = document.getElementById("clPreview");
        document.getElementById("cl-preview")?.addEventListener("click", () => {
          wrap.style.display = "block";
          frame.src = "/cover-letter?letter_only=1";
        });
      });
    </script>
  {% endif %}
{% endblock %}
