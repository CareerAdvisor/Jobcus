<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jobcus – AI Career Advisor</title>
  <link rel="icon" href="/static/icons/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header>
    <div class="logo">
      <a href="/">
      <img src="/static/jobcus-logo.png" alt="Jobcus">
      </a>
    </div>
    <div class="hamburger" id="hamburger"></div>
    <div class="header-icons" id="desktop-icons">
      <div class="dropdown-menu">
        <img src="/static/icons/ellipsis.svg" alt="Options">
        <div class="dropdown-content">
          <div onclick="exportPdf()"><img src="/static/icons/pdf.svg" alt="PDF"> Export as PDF</div>
          <div onclick="exportDocx()"><img src="/static/icons/worddoc.svg" alt="Word"> Export as DOCX</div>
          <div onclick="clearChat()"><img src="/static/icons/delete.svg" alt="Delete"> Delete</div>
        </div>
      </div>
      <img src="/static/icons/share.svg" alt="Share" id="shareIcon">
    </div>
  </header>

  <div id="menuOverlay" class="mobile-menu-overlay"></div>
  <div class="mobile-menu" id="mobileMenu">
    <img src="/static/icons/pencilchat.svg" alt="New Chat" onclick="clearChat()">
    <img src="/static/icons/share.svg" alt="Share" onclick="sharePage()">
    <img src="/static/icons/ellipsis.svg" alt="Options">
  </div>

  <main class="centered" id="mainContainer">
    <div class="chatbox" id="chatbox"></div>
    <div id="job-results" class="job-results"></div>
    <form id="chat-form">
      <div class="center-wrapper" id="center-wrapper">
        <div class="prompt" id="prompt">
          <h1>What can I assist you with today?</h1>
        </div>
        <div class="input-container" id="inputContainer">
          <input type="text" id="userInput" placeholder="Ask your career question..." />
          <input type="text" id="locationInput" placeholder="Location (optional)" />
          <select id="jobType">
            <option value="">Job Type (optional)</option>
            <option value="remote">Remote</option>
            <option value="onsite">Onsite</option>
            <option value="hybrid">Hybrid</option>
          </select>
          <div class="icon-group">
            <label for="file-upload"><img src="/static/icons/paperclip.svg" alt="Attach"></label>
            <input id="file-upload" type="file" style="display: none;">
            <img src="/static/icons/mic.svg" alt="Mic" id="mic-button">
            <button type="submit"><img src="/static/icons/enter.svg" alt="Send"></button>
          </div>
        </div>
      </div>
    </form>

    <div class="search-suggestions">
      <div class="suggestion" onclick="insertSuggestion('How do I write a good CV?')">How do I write a good CV?</div>
      <div class="suggestion" onclick="insertSuggestion('What are trending tech jobs?')">What are trending tech jobs?</div>
      <div class="suggestion" onclick="insertSuggestion('How can I get into cybersecurity?')">How can I get into cybersecurity?</div>
    </div>
  </main>

  <img id="scrollDown" class="scroll-down-icon" src="/static/icons/scrolldown.svg" alt="Scroll Down" onclick="scrollToBottom()">
  <img src="/static/icons/pencilchat.svg" class="start-new-chat-icon" alt="New Chat" title="Start a new chat" onclick="clearChat()">

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    function insertSuggestion(text) {
      document.getElementById("userInput").value = text;
      document.getElementById("userInput").focus();
    }
  </script>
  <script>
    const hamburger = document.getElementById("hamburger");
    const mobileMenu = document.getElementById("mobileMenu");
    const menuOverlay = document.getElementById("menuOverlay");

    hamburger.addEventListener("click", () => {
      mobileMenu.classList.toggle("active");
      menuOverlay.classList.toggle("active");
    });

    menuOverlay.addEventListener("click", () => {
      mobileMenu.classList.remove("active");
      menuOverlay.classList.remove("active");
    });

    function sharePage() {
      navigator.clipboard.writeText(window.location.href);
      alert("Link copied!");
    }

    const form = document.getElementById("chat-form");
    const input = document.getElementById("userInput");
    const chatbox = document.getElementById("chatbox");
    const prompt = document.getElementById("prompt");
    const centerWrapper = document.getElementById("center-wrapper");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const message = input.value.trim();
      const location = document.getElementById("locationInput").value.trim();
      const jobType = document.getElementById("jobType").value.trim();
      if (!message) return;

      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message }),
      });

      input.value = "";

      const data = await res.json();
      prompt.style.display = 'none';
      document.querySelector("main").classList.add("chat-started");

      const aiBlock = document.createElement("div");
      aiBlock.className = "chat-entry";
      const existingEntries = document.querySelectorAll(".chat-entry").length;
      aiBlock.innerHTML = `
        <div class='user-question'><h2>${message}</h2></div>
        <div class='ai-answer'>
          <img src='/static/icons/copy.svg' alt='Copy' class='copy-icon'>
          <span class="typed-response"></span>
        </div>
        ${existingEntries > 0 ? "<hr>" : ""}
      `;
      chatbox.prepend(aiBlock);

      const typedSpan = aiBlock.querySelector(".typed-response");
      const replyText = marked.parse(data.reply);
      let i = 0;
      const typingSpeed = 2;

      const typingInterval = setInterval(() => {
        typedSpan.innerHTML = replyText.slice(0, i);
        i++;
        if (i > replyText.length) {
          clearInterval(typingInterval);
          aiBlock.querySelector(".copy-icon").onclick = () => navigator.clipboard.writeText(data.reply);
          const existingHistory = localStorage.getItem("chatHistory") || "";
          const updatedHistory = aiBlock.outerHTML + existingHistory;
          localStorage.setItem("chatHistory", updatedHistory);
        }
      }, typingSpeed);

      // Fetch jobs
      const jobRes = await fetch("/jobs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: message, location, jobType })
      });
      const jobs = await jobRes.json();

      const jobResultsDiv = document.getElementById("job-results");
      jobResultsDiv.innerHTML = "";

      [...jobs.remotive, ...jobs.adzuna].forEach(job => {
        const jobDiv = document.createElement("div");
        jobDiv.className = "job-item";
        jobDiv.innerHTML = `<strong>${job.title}</strong> - ${job.company} (${job.location})<br><a href="${job.url}" target="_blank">View Job</a>`;
        jobResultsDiv.appendChild(jobDiv);
      });
    });

    window.addEventListener("DOMContentLoaded", () => {
      const saved = localStorage.getItem("chatHistory");
      if (saved) {
        chatbox.innerHTML = saved;
        prompt.style.display = 'none';
        document.querySelector("main").classList.add("chat-started");
      }
    });

    document.getElementById("mic-button").addEventListener("click", () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.start();
      recognition.onresult = (e) => {
        input.value = e.results[0][0].transcript;
      };
    });

    input.addEventListener("keypress", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event("submit"));
      }
    });

    function clearChat() {
      chatbox.innerHTML = "";
      prompt.style.display = 'block';
      localStorage.removeItem("chatHistory");
      document.querySelector("main").classList.remove("chat-started");
      document.getElementById("job-results").innerHTML = "";
    }

    function exportDocx() {
      alert("Exporting to DOCX – feature under development");
    }

    function exportPdf() {
      alert("Exporting to PDF – feature under development");
    }

    function scrollToBottom() {
      chatbox.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById("shareIcon").addEventListener("click", () => {
      navigator.clipboard.writeText(window.location.href);
      alert("Page link copied to clipboard.");
    });
  </script>
</body>
</html>
