{% extends "base.html" %}

{% block title %}My Dashboard ‚Äì Jobcus{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<section class="dashboard-container">

  <!-- Upload Card -->
  <div id="uploadCard" class="card upload-card">
    <p class="upload-lead">
      Upload a PDF/DOCX. Optionally add a job description to check keyword match.
    </p>

    <!-- Dropzone (click hits the hidden input) -->
    <div id="dropZone" class="dropzone" tabindex="0" role="button" aria-label="Browse files">
      <div class="dropzone-icon" aria-hidden="true">‚§¥Ô∏é</div>
      <div class="dropzone-title">Browse Files</div>
      <div class="dropzone-sub">Drag and drop files here</div>
      <input id="dashResumeFile" type="file" accept=".pdf,.docx" hidden />
    </div>

    <!-- Optional JD + Role relevance -->
    <textarea id="dashJobDesc" class="input textarea" placeholder="Optional: paste job description to check keywords‚Ä¶"></textarea>

    <div class="role-picker">
      <label for="roleSelect">Or pick a target role to assess relevance</label>
      <select id="roleSelect" class="input select">
        <option value="">‚Äî Choose a role (optional) ‚Äî</option>
        <option>IT Support Specialist</option>
        <option>Software Engineer</option>
        <option>Data Analyst</option>
        <option>Project Manager</option>
        <option>UX Designer</option>
        <option>Cybersecurity Analyst</option>
      </select>
    </div>

    <div class="actions">
      <button id="dashAnalyzeBtn" class="btn btn-primary">Analyze resume</button>
      <span id="dashAnalyzing" class="analyzing" hidden>ü§ñ Analyzing‚Ä¶</span>
    </div>

    <small class="muted">We‚Äôll store your latest result on this device for quick access.</small>
  </div>

  <!-- Score + Breakdown -->
  <div class="grid">
    <div class="card score-card">
      <div class="score-card__top">
        <div class="doc-chip" aria-hidden="true">üìÑ</div>
        <button id="openReanalyze" class="btn btn-outlined">Analyze updated resume</button>
      </div>

      <div class="score-ring">
        <svg viewBox="0 0 36 36" class="ring">
          <path class="ring-track" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path class="ring-progress" stroke-dasharray="0,100"
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <text x="18" y="21" class="ring-label">0%</text>
        </svg>
      </div>

      <div class="mini-metrics">
        <div class="metric"><span>Formatting</span><strong id="m-formatting">‚Äî</strong><div class="bar"><div id="b-formatting"></div></div></div>
        <div class="metric"><span>Sections</span><strong id="m-sections">‚Äî</strong><div class="bar"><div id="b-sections"></div></div></div>
        <div class="metric"><span>Readability</span><strong id="m-readability">‚Äî</strong><div class="bar"><div id="b-readability"></div></div></div>
        <div class="metric"><span>Length</span><strong id="m-length">‚Äî</strong><div class="bar"><div id="b-length"></div></div></div>
        <div class="metric"><span>Parseable</span><strong id="m-parseable">‚Äî</strong><div class="bar"><div id="b-parseable"></div></div></div>
      </div>

      <p id="metric-note" class="metric-note">Last analyzed: ‚Äî</p>
    </div>

    <!-- Optimize side menu + single dynamic panel -->
    <aside class="card optimize">
      <h3>Optimize</h3>
      <nav class="opt-menu" role="tablist" aria-label="Resume optimization">
        <button class="opt-tab is-active" data-target="fixes" role="tab" aria-selected="true">Fixes needed</button>
        <button class="opt-tab" data-target="strengths" role="tab" aria-selected="false">Done well</button>
        <button class="opt-tab" data-target="ats" role="tab" aria-selected="false">ATS keywords</button>
        <button class="opt-tab" data-target="writing" role="tab" aria-selected="false">Writing quality</button>
      </nav>
    </aside>
  </div>

  <!-- SINGLE dynamic panel that swaps content -->
  <section id="optimize-panel" class="card panel">
    <!-- filled by JS depending on selected tab -->
  </section>

  <!-- Optimize CTA: always shown -->
  <section class="card optimize-cta">
    <p>Want us to apply these fixes automatically? ‚ú®</p>
    <button id="optimize-btn" class="btn btn-primary">Optimize My Resume</button>

    <div id="optimized-loading" class="muted" hidden>ü§ñ Optimizing your resume, please wait‚Ä¶</div>
    <pre id="optimized-output" class="opt-output" hidden></pre>

    {% if current_user.is_authenticated %}
      <div id="optimized-downloads" class="opt-dl" hidden>
        <button onclick="downloadOptimizedResume('pdf')" class="btn btn-light">‚¨áÔ∏è Download PDF</button>
        <button onclick="downloadOptimizedResume('txt')" class="btn btn-light">‚¨áÔ∏è Download TXT</button>
      </div>
    {% else %}
      <div class="muted">
        To download your optimized resume, <a href="/account">Sign up or log in</a>.
      </div>
    {% endif %}
  </section>

  <!-- Empty state if nothing analyzed yet -->
  <div id="no-analysis-cta" class="empty">
    <p>You haven‚Äôt analyzed a resume yet. Use the upload panel above to get started.</p>
  </div>

</section>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.1/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script defer src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
