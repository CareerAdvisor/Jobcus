{% extends "base.html" %}

{% block title %}My Dashboard – Jobcus{% endblock %}

{% block content %}
<section class="dashboard-container" style="max-width:1100px;margin:0 auto;padding:20px 16px;">

  <h1 id="dashboardGreeting" class="dashboard-title" style="margin:0 0 6px;"></h1>
  <p class="dashboard-subtitle" style="margin:0 0 18px;color:#555;">
    Track your career growth and insights powered by Jobcus AI.
  </p>

  <!-- ===== Top row: Score + Quick Re-analyze ===== -->
  <div style="display:grid;grid-template-columns:1fr 1.1fr;gap:16px;align-items:start;">
    
    <!-- Score card -->
    <div class="dashboard-card" id="resume-score-card" style="display:none;background:#fff;border:1px solid #ececec;border-radius:12px;padding:18px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="margin:0;">📄 Resume Score</h3>
        <button id="openReanalyze" class="cta-secondary" style="border:1px solid #104879;background:#fff;color:#104879;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;">
          Analyze updated resume
        </button>
      </div>

      <div style="display:flex;gap:16px;align-items:center;">
        <div class="progress-circle" data-score="0" style="width:130px;height:130px;">
          <svg viewBox="0 0 36 36">
            <!-- track -->
            <path class="bg" stroke="#eee" stroke-width="3.8" fill="none"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"/>
            <!-- progress (color set in JS) -->
            <path class="progress" stroke="#16A34A" stroke-width="3.8" fill="none" stroke-linecap="round"
              stroke-dasharray="0,100"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"/>
            <!-- center text -->
            <text x="18" y="20.35" class="percentage" text-anchor="middle" font-size="8" fill="#104879">0%</text>
          </svg>
          <p class="metric-note" id="metric-note" style="font-size:12px;color:#666;margin:8px 0 0;text-align:center;">
            Last analyzed: just now
          </p>
        </div>

        <!-- ATS breakdown -->
        <div style="flex:1;">
          <h4 style="margin:0 0 8px;">ATS Readiness</h4>
          <div id="ats-grid" style="display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:8px;">
            <!-- filled by JS -->
          </div>
          <small style="display:block;color:#666;margin-top:8px;">Higher is better. Aim for green across the board.</small>
        </div>
      </div>
    </div>

    <!-- Re-analyze / Upload panel (always visible) -->
    <div class="dashboard-card" style="background:#fff;border:1px solid #ececec;border-radius:12px;padding:18px;">
      <h3 style="margin:0 0 8px;">Analyze a resume</h3>
      <p style="margin:0 0 12px;color:#555;">Upload a PDF/DOCX or paste text. Optionally add a job description to check keyword match.</p>

      <input type="file" id="dashResumeFile" accept=".pdf,.docx" style="display:block;margin:6px 0 10px;">

      <textarea id="dashResumeText" placeholder="Or paste your resume text here…"
        style="width:100%;height:90px;padding:12px;border:1px solid #ccc;border-radius:8px;margin:0 0 10px;font-size:14px;"></textarea>

      <textarea id="dashJobDesc" placeholder="Optional: paste job description to check keywords…"
        style="width:100%;height:70px;padding:12px;border:1px solid #ccc;border-radius:8px;margin:0 0 12px;font-size:14px;"></textarea>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <button id="dashAnalyzeBtn" class="primary-btn"
          style="background:#104879;color:#fff;padding:12px 16px;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
          Analyze resume
        </button>
        <span id="dashAnalyzing" style="display:none;color:#555;">🤖 Analyzing…</span>
      </div>
      <small style="display:block;margin-top:10px;color:#666;">We’ll store your latest result on this device for quick access.</small>
    </div>
  </div>

  <!-- If no analysis saved yet, show CTA under the top row -->
  <div id="no-analysis-cta" style="text-align:center; margin:18px 0 0;">
    <p>You haven’t analyzed a resume yet.</p>
    <a href="/resume-analyzer" class="cta-primary" style="display:inline-block;background:#104879;color:#fff;padding:10px 14px;border-radius:8px;text-decoration:none;font-weight:600;">Analyze on Analyzer page</a>
  </div>

  <!-- ===== Detailed Analysis ===== -->
  <section id="resume-analysis" class="analysis-section" style="display:none; margin-top:22px;">
    <h2 style="margin:0 0 10px;">🔍 Detailed Findings & Recommendations</h2>

    <!-- Keyword match & sections (optional; only shown if data exists) -->
    <div id="optional-panels" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:10px 0;">
      <div id="kw-panel" class="analysis-block" style="display:none;background:#fff;border:1px solid #ececec;border-radius:12px;padding:16px;">
        <h3 style="margin:0 0 8px;">🎯 Job Keyword Match</h3>
        <div style="display:flex;gap:16px;">
          <div style="flex:1;">
            <h4 style="margin:0 0 6px;font-size:14px;">Matched</h4>
            <ul id="kw-matched" style="margin:0;padding-left:18px;"></ul>
          </div>
          <div style="flex:1;">
            <h4 style="margin:0 0 6px;font-size:14px;">Missing</h4>
            <ul id="kw-missing" style="margin:0;padding-left:18px;"></ul>
          </div>
        </div>
      </div>

      <div id="sections-panel" class="analysis-block" style="display:none;background:#fff;border:1px solid #ececec;border-radius:12px;padding:16px;">
        <h3 style="margin:0 0 8px;">📋 Resume Sections</h3>
        <div style="display:flex;gap:16px;">
          <div style="flex:1;">
            <h4 style="margin:0 0 6px;font-size:14px;">Present</h4>
            <ul id="sec-present" style="margin:0;padding-left:18px;"></ul>
          </div>
          <div style="flex:1;">
            <h4 style="margin:0 0 6px;font-size:14px;">Missing</h4>
            <ul id="sec-missing" style="margin:0;padding-left:18px;"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Core issues/strengths/suggestions -->
    <div class="analysis-block issues" style="background:#fff;border:1px solid #ececec;border-radius:12px;padding:16px;">
      <h3 style="margin:0 0 8px;">⚠️ Issues Found</h3>
      <ul id="top-issues" style="margin:0;padding-left:18px;"></ul>
    </div>

    <div class="analysis-block strengths" style="margin-top:16px;background:#fff;border:1px solid #ececec;border-radius:12px;padding:16px;">
      <h3 style="margin:0 0 8px;">✅ What You Did Well</h3>
      <ul id="good-points" style="margin:0;padding-left:18px;"></ul>
    </div>

    <div class="analysis-block suggestions" style="margin-top:16px;background:#fff;border:1px solid #ececec;border-radius:12px;padding:16px;">
      <h3 style="margin:0 0 8px;">💡 Suggestions</h3>
      <ul id="suggestions-list" style="margin:0;padding-left:18px;"></ul>
    </div>

    <!-- Optimize -->
    <div class="analysis-cta" style="margin-top:16px; background:#f8fafc;border:1px dashed #cbd5e1;border-radius:10px;padding:16px;text-align:center;">
      <p style="margin:0 0 8px;">Want us to apply these fixes automatically? ✨</p>
      <button id="optimize-btn" class="btn-optimize" style="background:#104879;color:#fff;padding:10px 14px;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Optimize My Resume</button>
    </div>

    <div id="optimize-section" style="margin-top:14px; display:flex; flex-direction:column; align-items:center;">
      <div id="optimized-loading" style="display:none; color:#555;">
        🤖 Optimizing your resume, please wait…
      </div>
      <pre id="optimized-output" style="display:none; white-space:pre-wrap; background:#fff;border:1px solid #ececec; padding:12px; border-radius:8px; max-width:100%; overflow:auto;"></pre>

      {% if current_user.is_authenticated %}
        <div id="optimized-downloads" style="display:none; margin-top:10px;">
          <button onclick="downloadOptimizedResume('pdf')" style="margin-right:6px;">⬇️ Download PDF</button>
          <button onclick="downloadOptimizedResume('txt')">⬇️ Download TXT</button>
        </div>
      {% else %}
        <div style="margin-top:10px; text-align:center;">
          <p>
            To download your optimized resume, 
            <strong><a href="/account" style="color: #104879; text-decoration: none;">Sign up or log in</a></strong>.
          </p>
        </div>
      {% endif %}
    </div>
  </section>
</section>
{% endblock %}

{% block scripts %}
<!-- DOCX / FileSaver / jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.1/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Dashboard logic -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
