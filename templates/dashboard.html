{% extends "base.html" %}

{% block title %}My Dashboard ‚Äì Jobcus{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<section class="dash-wrap">
  <h1 id="dashboardGreeting" class="dashboard-title"></h1>
  <p class="dashboard-subtitle">Track your career growth and insights powered by Jobcus AI.</p>

  <div class="top-stack">
    <!-- Score card -->
    <div class="dashboard-card score-card" id="resume-score-card" style="display:none;">
      <div class="score-card__head">
        <h3>üìÑ Resume Score</h3>
        <button id="openReanalyze" class="btn btn-outline">Analyze updated resume</button>
      </div>

      <div class="score-card__body">
        <!-- score ring -->
        <div class="ring-wrap">
          <div class="progress-circle" data-score="0">
            <svg viewBox="0 0 36 36" class="ring">
              <path class="ring-track"
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <path class="ring-progress" stroke-dasharray="0,100"
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <text x="18" y="20.35" class="ring-text" text-anchor="middle">0%</text>
            </svg>
          </div>
          <p id="metric-note" class="metric-note">Last analyzed: just now</p>
        </div>

        <!-- ATS breakdown -->
        <div class="ats-wrap">
          <h4>ATS Readiness</h4>
          <div id="ats-grid" class="ats-grid"><!-- filled by JS --></div>
          <small class="ats-hint">Higher is better. Aim for green across the board.</small>
        </div>
      </div>
    </div>

    <!-- Upload / re-analyze -->
    <div class="dashboard-card upload-card">
      <h3>Analyze a resume</h3>
      <p class="upload-card__sub">Upload a PDF/DOCX. Optionally add a job description to check keyword match.</p>

      <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Upload resume">
        <svg class="dz-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"
             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M3 15.75a4.5 4.5 0 0 0 4.5 4.5h9a4.5 4.5 0 0 0 .9-8.91A6 6 0 1 0 6.75 9" />
          <path d="M12 12v8M9 14l3-3 3 3" />
        </svg>
        <div class="dz-title">Browse Files</div>
        <p class="dz-sub">Drag and drop files here</p>
        <div id="dzFileName" class="dz-file" style="display:none;"></div>
        <input id="dashResumeFile" type="file" accept=".pdf,.docx" hidden>
      </div>

      <textarea id="dashJobDesc" class="textarea"
        placeholder="Optional: paste job description to check keywords‚Ä¶"></textarea>

      <div class="upload-actions">
        <button id="dashAnalyzeBtn" class="btn btn-primary" disabled>Analyze resume</button>
        <span id="dashAnalyzing" class="analyzing">ü§ñ Analyzing‚Ä¶</span>
      </div>

      <small class="upload-note">We‚Äôll store your latest result on this device for quick access.</small>
    </div>
  </div>

  <!-- Empty state -->
  <div id="no-analysis-cta" class="empty-state">
    <p>You haven‚Äôt analyzed a resume yet. Use the upload panel above to get started.</p>
  </div>

  <!-- RESULTS LAYOUT: side menu + main content -->
  <div id="analysisLayout" class="analysis-grid" style="display:none;">
    <!-- Dynamic actions/menu -->
    <aside id="actionsMenu" class="actions-menu">
      <h3 class="actions-title">Optimize</h3>
      <button class="menu-item" data-target="#panel-issues">
        <span>Fixes needed</span>
        <span class="badge" id="countIssues">0</span>
      </button>
      <button class="menu-item" data-target="#panel-strengths">
        <span>What you did well</span>
        <span class="badge" id="countStrengths">0</span>
      </button>
      <button class="menu-item" data-target="#panel-keywords">
        <span>ATS Keywords</span>
        <span class="badge" id="countMissing">0</span>
      </button>
      <button class="menu-item" data-target="#aiEditor">
        <span>AI editor</span>
      </button>
      <button class="menu-item" data-target="#dropzone">
        <span>Upload new version</span>
      </button>
    </aside>

    <!-- Main results -->
    <div class="analysis-main">
      <section id="resume-analysis" class="analysis-section" style="display:none;">
        <h2>üîç Detailed Findings & Recommendations</h2>

        <div class="opt-panels">
          <div id="panel-keywords" class="panel" style="display:none;">
            <h3>üéØ Job Keyword Match</h3>
            <div class="panel-split">
              <div>
                <h4>Matched</h4>
                <ul id="kw-matched" class="list"></ul>
              </div>
              <div>
                <h4>Missing</h4>
                <ul id="kw-missing" class="list"></ul>
              </div>
            </div>
          </div>

          <div id="panel-sections" class="panel" style="display:none;">
            <h3>üìã Resume Sections</h3>
            <div class="panel-split">
              <div>
                <h4>Present</h4>
                <ul id="sec-present" class="list"></ul>
              </div>
              <div>
                <h4>Missing</h4>
                <ul id="sec-missing" class="list"></ul>
              </div>
            </div>
          </div>
        </div>

        <div id="panel-issues" class="panel">
          <h3>‚ö†Ô∏è Fixes needed</h3>
          <ul id="top-issues" class="list"></ul>
        </div>

        <div id="panel-strengths" class="panel">
          <h3>‚úÖ What you did well</h3>
          <ul id="good-points" class="list"></ul>
        </div>

        <div class="panel">
          <h3>üí° Suggestions</h3>
          <ul id="suggestions-list" class="list"></ul>
        </div>

        <div class="opt-cta">
          <p>Want us to apply these fixes automatically? ‚ú®</p>
          <button id="optimize-btn" class="btn btn-primary">Optimize My Resume</button>
        </div>

        <div class="panel" id="aiEditor">
          <h3>ü§ñ AI editor</h3>
          <p>Paste a sentence or bullet you want to improve and say how to change it.</p>
          <textarea id="aiEditInput" class="textarea" placeholder="Paste a bullet or short paragraph‚Ä¶"></textarea>
          <input id="aiEditInstruction" class="input" placeholder="e.g., Make it concise and add a metric" />
          <div class="upload-actions">
            <button id="aiEditRun" class="btn btn-outline">Rewrite</button>
          </div>
          <pre id="aiEditOutput" class="output"></pre>
        </div>

        <div class="opt-output">
          <div id="optimized-loading" class="loading">ü§ñ Optimizing your resume, please wait‚Ä¶</div>
          <pre id="optimized-output" class="output"></pre>

          {% if current_user.is_authenticated %}
            <div id="optimized-downloads" class="downloads">
              <button onclick="downloadOptimizedResume('pdf')" class="btn">‚¨áÔ∏è Download PDF</button>
              <button onclick="downloadOptimizedResume('txt')" class="btn">‚¨áÔ∏è Download TXT</button>
            </div>
          {% else %}
            <div class="downloads">
              <p>To download your optimized resume,
                <strong><a href="/account">Sign up or log in</a></strong>.
              </p>
            </div>
          {% endif %}
        </div>
      </section>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.1/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
