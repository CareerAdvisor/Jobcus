{% extends "base.html" %}

{% block title %}My Dashboard – Jobcus{% endblock %}

{% set wm = (current_user.email ~ " · Jobcus") if current_user.is_authenticated else "Guest · Jobcus" %}
{% set is_paid = (current_user.is_authenticated and (current_user.plan|lower in ['standard','premium'])) %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% set _first = None %}
{% if current_user.is_authenticated %}
  {% set _first = (
      current_user.first_name
      or (current_user.fullname.split(' ')[0] if current_user.fullname else None)
      or (current_user.email.split('@')[0] if current_user.email else None)
  ) %}
{% endif %}

{% block content %}
<section class="dash-shell">
  <h1 class="dash-title">
    {% if _first %}Welcome back, {{ _first }}{% else %}Welcome back{% endif %}
  </h1>
  <p class="dash-subtitle">Track your career growth and insights powered by Jobcus AI.</p>

  <!-- NUDGE: appears after 3 free analyses for anonymous users -->
  <div id="registerNudge" class="nudge" style="display:none">
    <strong>Enjoying the analyzer?</strong>
    You’ve used your 3 free analyses. Create a free account to save history and unlock more features.
    <a class="btn btn-primary" href="/account">Create account</a>
    <button class="btn-link" id="dismissNudge" aria-label="dismiss">Dismiss</button>
  </div>

  <!-- ===== Score card + Upload (stacked, centered) ===== -->
  <div class="dash-stack">
    <!-- Upload card -->
    <article class="card upload-card">
      <h3 class="upload-title">Upload a PDF/DOCX. Optionally add a job description to check keyword match.</h3>

      <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Browse files, drag and drop files here">
        <div class="dropzone__cloud" aria-hidden="true"></div>
        <div class="dropzone__title">Browse Files</div>
        <div class="dropzone__hint">Drag and drop files here</div>
        <input id="dashResumeFile" type="file" accept=".pdf,.docx" hidden>
      </div>
      <div id="fileName" class="file-name" aria-live="polite"></div>

      <label class="field">
        <span class="field__label sr-only">Job description (optional)</span>
        <textarea id="dashJobDesc" class="textarea" placeholder="Optional: paste job description to check keywords…"></textarea>
      </label>

      <label class="field">
        <span class="field__label center">Or pick a target role to assess relevance</span>
        <input id="dashRoleSelect" class="select"
               list="roleList"
               placeholder="Start typing a role (e.g., Business Analyst, Azure Architect, Animator)…" />
        <datalist id="roleList"></datalist>
      </label>

      <div class="actions">
        <button id="dashAnalyzeBtn" class="btn btn-primary" disabled>Analyze resume</button>
        <span id="dashAnalyzing" class="loading" style="display:none;">Analyzing…</span>
      </div>

      <p class="help">We’ll store your latest result on this device for quick access.</p>
    </article>

    <!-- Score card -->
    <article class="card score-card" id="resume-score-card" aria-live="polite" style="display:none">
      <div class="score-card__top">
        <div class="score-card__icon" aria-hidden="true"></div>
        <button id="openReanalyze" class="btn btn-outline">Analyze updated resume</button>
      </div>

      <div class="score-card__body">
        <div class="ring" role="img" aria-label="Resume score">
          <svg viewBox="0 0 120 120">
            <circle class="ring__track" cx="60" cy="60" r="52"></circle>
            <circle class="ring__progress" cx="60" cy="60" r="52" stroke-dasharray="0 400"></circle>
            <text x="60" y="68" class="ring__label">0%</text>
          </svg>
        </div>

        <div class="metrics">
          <div class="metric">
            <div class="metric__head"><span>Formatting</span><strong id="mFormatting">—%</strong></div>
            <div class="bar"><div class="bar__fill" id="bFormatting"></div></div>
          </div>

          <div class="metric">
            <div class="metric__head"><span>Sections</span><strong id="mSections">—%</strong></div>
            <div class="bar"><div class="bar__fill" id="bSections"></div></div>
          </div>

          <div class="metric">
            <div class="metric__head"><span>Keywords</span><strong id="mKeywords">—%</strong></div>
            <div class="bar"><div class="bar__fill" id="bKeywords"></div></div>
          </div>

          <div class="metric">
            <div class="metric__head"><span>Readability</span><strong id="mReadability">—%</strong></div>
            <div class="bar"><div class="bar__fill" id="bReadability"></div></div>
          </div>

          <div class="metric">
            <div class="metric__head"><span>Length</span><strong id="mLength">—%</strong></div>
            <div class="bar"><div class="bar__fill" id="bLength"></div></div>
          </div>

          <div class="metric metric--wide">
            <div class="metric__head"><span>Parseable</span><strong id="mParseable">—%</strong></div>
            <div class="bar"><div class="bar__fill" id="bParseable"></div></div>
          </div>
        </div>

      <footer class="score-card__foot">
        <p class="metric-note" id="metric-note">Last analyzed: —</p>
        <small>Higher is better. Aim for green across the board.</small>
      </footer>
    </article>
  </div> <!-- end .dash-stack -->

  <div id="no-analysis-cta" class="no-analysis" style="display:none;">
    <p>You haven’t analyzed a resume yet. Use the upload panel above to get started.</p>
  </div>

  <section class="opt-shell">
    <aside class="opt-nav" aria-label="Optimize menu">
      <button class="opt-btn is-active" data-view="fixes">Fixes needed</button>
      <button class="opt-btn" data-view="done">Done well</button>
      <button class="opt-btn" data-view="keywords">ATS keywords</button>
      <button class="opt-btn" data-view="writing">Writing quality</button>
      
      <!-- New entries using the SAME style -->
      <hr style="border:none;border-top:1px dashed #e5e7eb;margin:8px 0;" aria-hidden="true">
      <button class="opt-btn" data-view="analysis">Resume analysis</button>
      <button class="opt-btn" data-view="verbs">Power verbs</button>
      <button class="opt-btn" data-view="ai">AI helper</button>
    </aside>
  
    <div class="opt-panel" id="optPanel"></div>
  </section>

  <section class="opt-cta">
    <p class="opt-explain">
      Use the recommended fixes above to update your resume, or utilise our ATS-optimised resume builder feature to create a new one.
    </p>
    <div class="actions" style="display:flex;gap:.75rem;flex-wrap:wrap;">
      <a id="rebuild-ai-btn" class="btn btn-primary" href="/resume-builder">Rebuild with AI</a>
    </div>
    <small class="help">“Rebuild with AI” opens the Resume Builder page.</small>
  </section>
</section>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.1/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Dashboard logic (upload, score card, + the extra tabs renderers) -->
  <script>
    // Endpoint used by AI Helper / Resume analysis tabs (don't overwrite if already set)
    window.AI_ENDPOINT = window.AI_ENDPOINT || "/api/ai-helper";

    // Minimal escapeHtml (same contract as in resume-builder.js); define only if missing
    if (typeof window.escapeHtml !== "function") {
      window.escapeHtml = (s = "") =>
        s.replace(/&/g,"&amp;").replace(/</g,"&lt;")
         .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }

    // Centralized response handling; define only if missing
    if (typeof window.handleCommonErrors !== "function") {
      window.handleCommonErrors = async function(res){
        if (res.ok) return null;
        const ct = res.headers.get("content-type") || "";
        let body = null;
        try {
          body = ct.includes("application/json") ? await res.json()
                                                 : { message: await res.text() };
        } catch {}
        if (res.status === 402 || (res.status === 403 && body?.error === "upgrade_required")) {
          const msg = body?.message || "You’ve reached your plan limit. Upgrade to continue.";
          window.upgradePrompt?.(body?.message_html || msg, (window.PRICING_URL || "/pricing"), 1200);
          throw new Error(msg);
        }
        if (res.status === 401 || res.status === 403) {
          const msg = body?.message || "Please sign in to continue.";
          window.showUpgradeBanner?.(msg);
          setTimeout(() => { window.location.href = "/account?mode=login"; }, 800);
          throw new Error(msg);
        }
        if (res.status === 429 && (body?.error === "too_many_free_accounts" || body?.error === "device_limit")) {
          const msg = body?.message || "Too many free accounts detected from your network/device.";
          window.showUpgradeBanner?.(msg);
          throw new Error(msg);
        }
        const msg = body?.message || `Request failed (${res.status})`;
        throw new Error(msg);
      };
    }
  </script>

  <script defer src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
