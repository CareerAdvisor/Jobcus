{% extends "base.html" %}
{% block title %}Reset Password{% endblock %}

{% block content %}
<section class="account-container">
  <div class="account-box">
    <h2>Create a New Password</h2>

    <!-- Feedback area -->
    <div id="resetStatus" class="flash-message" style="display:none;"></div>

    <form id="resetForm">
      <div class="form-group">
        <label>New Password</label>
        <input type="password" name="password" id="newPassword" required />
      </div>
      <button type="submit" class="cta-primary" id="resetBtn" disabled>Reset Password</button>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (async () => {
      const supabaseUrl = "{{ config['SUPABASE_URL'] }}";
      const supabaseAnonKey = "{{ config['SUPABASE_ANON_KEY'] }}";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
        auth: { persistSession: true, autoRefreshToken: true }
      });

      const statusEl = document.getElementById('resetStatus');
      const formEl = document.getElementById('resetForm');
      const btnEl = document.getElementById('resetBtn');

      function show(msg, kind = 'info') {
        statusEl.textContent = msg;
        statusEl.className = 'flash-message ' + kind;
        statusEl.style.display = 'block';
      }

      // --- Step A: Establish a session from URL tokens ---
      // Supabase may send either `?code=...` OR a URL fragment with `#access_token=...&refresh_token=...&type=recovery`
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');

      // Hash helper (for older flows)
      const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, ''));
      const access_token  = hashParams.get('access_token');
      const refresh_token = hashParams.get('refresh_token');
      const type = hashParams.get('type');

      try {
        if (code) {
          // Newer PKCE-style recovery links
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          if (error || !data?.session) throw error || new Error('No session');
        } else if (type === 'recovery' && access_token && refresh_token) {
          // Older hash-style recovery links
          const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
          if (error || !data?.session) throw error || new Error('No session');
          // Clean the hash from the URL
          history.replaceState({}, document.title, window.location.pathname);
        } else {
          // If no token, user came here directly
          show('Your reset link is invalid or expired. Please request a new one.', 'error');
          return;
        }
        btnEl.disabled = false; // user is now authenticated for recovery
      } catch (e) {
        show('Your reset link is invalid or expired. Please request a new one.', 'error');
        return;
      }

      // --- Step B: On submit, actually change the password ---
      formEl.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        btnEl.disabled = true;

        const password = document.getElementById('newPassword').value.trim();
        if (!password) { show('Please enter a new password.', 'error'); btnEl.disabled = false; return; }

        const { data, error } = await supabase.auth.updateUser({ password });
        if (error) {
          show('Could not reset your password. Please request a new link and try again.', 'error');
          btnEl.disabled = false;
          return;
        }

        // Success UX: sign out the recovery session, send back to login
        await supabase.auth.signOut();
        show('Password updated successfully. Redirecting to sign inâ€¦', 'success');
        setTimeout(() => { window.location.href = "{{ url_for('account', mode='login') }}"; }, 1500);
      });
    })();
  </script>
{% endblock %}
