{% extends "base.html" %}
{% block title %}Chat with Jobcus{% endblock %}
{% block body_class %}chat-page{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
{% endblock %}

{# Left ‚Äúsidebar‚Äù toggle icon in the header #}
{% block header_icon %}
  <img
    id="chatMenuToggle"
    src="{{ url_for('static', filename='icons/sidebar.svg') }}"
    class="header-menu-icon"
    alt="Open chat menu"
    title="Menu"
  />
{% endblock %}

{% set show_footer = false %}

{# --- Plan/model helpers (works even if you didn‚Äôt pass vars explicitly) --- #}
{% set plan_code = (plan if plan is defined else ((current_user.plan if current_user.is_authenticated else '') or 'free')) %}
{% set is_paid   = (is_paid if is_paid is defined else (plan_code != 'free')) %}
{% set free_model    = (free_model if free_model is defined else 'gpt-4o-mini') %}
{% set model_default = (model_default if model_default is defined else (is_paid and 'gpt-4o' or free_model)) %}
{% set model_options = (model_options if model_options is defined else ['gpt-4o','gpt-4o-mini']) %}
{% set show_upgrade  = (show_upgrade if show_upgrade is defined else (plan_code == 'free')) %}

{% block content %}
<main id="chatShell"
      class="chat-shell"
      data-is-paid="{{ 1 if is_paid else 0 }}"
      data-default-model="{{ model_default }}"
      data-free-model="{{ free_model }}"
      data-allowed-models="{{ model_options|join(',') }}">

  <!-- LEFT: fixed sidebar (menus + credits + new chat) -->
  <aside id="chatSidebar" class="chat-sidebar" aria-label="Chat menu">
    <div class="sidebar-header">
      <button id="chatSidebarClose" class="sb-btn" type="button" aria-label="Close menu">‚úï Close</button>
      <!-- New chat lives in the sidebar now -->
      <button id="newChatBtn" class="sb-btn sb-primary" type="button">New chat</button>
    </div>

    <!-- Quick links -->
    <nav class="sb-menu">
      <a class="sb-btn" href="/pricing">View pricing</a>
      <a class="sb-btn" href="/dashboard">Back to dashboard</a>
      <button id="clearChatBtn" class="sb-btn" type="button">Clear conversation</button>
    </nav>

    <!-- Credits panel (kept) + plan block + model controls -->
    <section class="credits-panel" aria-labelledby="credits-title">
      <h2 id="credits-title">AI Chat credits &amp; fair-use</h2>

      <div class="credits-row">
        <div>
          <div class="credits-label">Your plan</div>
          <strong id="credits-plan" data-plan="{{ plan_code }}">{{ plan_code|capitalize }}</strong>

          {% if plan_code == 'free' %}
            <div class="badge-pill mt-6">Trial</div>
          {% else %}
            <div class="badge-pill mt-6">Active</div>
          {% endif %}

          {% if show_upgrade %}
            <a class="btn-upgrade-inline" href="{{ url_for('pricing') }}">Upgrade</a>
          {% endif %}
        </div>
        <div>
          <div class="credits-label">Messages left</div>
          <strong id="credits-left">‚Äî</strong>
          <small id="credits-reset" class="credits-hint">
            {{ 'Resets weekly' if plan_code == 'weekly' else ('Resets monthly' if plan_code in ['free','standard'] else 'Fair use / yearly') }}
          </small>
        </div>
      </div>

      <div class="model-area">
        {% if is_paid %}
          <label for="modelSelect" class="model-label">Model</label>
          <select id="modelSelect" class="model-select">
            {% for m in model_options %}
              <option value="{{ m }}" {% if m == model_default %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
          <div class="model-current">Using: <span id="modelBadge">{{ model_default }}</span></div>
        {% else %}
          <label class="model-label">Model</label>
          <div class="badge-pill" title="Upgrade to switch models">{{ free_model }}</div>
          <div class="model-current">Using: <span id="modelBadge">{{ free_model }}</span></div>
        {% endif %}
      </div>

      <details class="credits-details">
        <summary>How credits work</summary>
        <ul class="credits-list">
          <li><strong>Free:</strong> 15 total messages (trial)</li>
          <li><strong>Weekly:</strong> 200 / week</li>
          <li><strong>Standard:</strong> 800 / month</li>
          <li><strong>Premium:</strong> 12,000 / year (~1,000 / mo)</li>
        </ul>
        <p class="credits-note">A ‚Äúmessage‚Äù is each prompt you send. When you run out, chat pauses until the next reset or upgrade.</p>
      </details>
    </section>

    <!-- ‚úÖ History goes here, inside the drawer -->
    <section class="history-panel">
      <h3 class="history-title">Conversation history</h3>
      <ul id="chatHistory" class="history-list"></ul>
    </section>
  </aside>
  <div id="chatOverlay" class="chat-overlay" hidden></div>

  <!-- RIGHT: chat content pane -->
  <section class="chat-main">
    <!-- Small model strip at the top of the chat pane -->
    <div class="model-strip">
      Model: <strong><span id="headerModel">{{ is_paid and model_default or free_model }}</span></strong>
    </div>

    <div class="chatbox" id="chatbox">
      <!-- welcome banner stays in the chat stream -->
      <div id="welcomeBanner" class="welcome">
        {% if current_user.is_authenticated and current_user.first_name %}
          <p class="welcome-title">üëã Welcome {{ current_user.first_name }}! How can I help you today?</p>
        {% else %}
          <p class="welcome-title">üëã Welcome! How can I help you today?</p>
        {% endif %}

        <div class="suggestion-chips">
          <button type="button" onclick="insertSuggestion('How do I improve my resume?')" class="chip">Improve my resume</button>
          <button type="button" onclick="insertSuggestion('Interview tips for a UX role')" class="chip">Interview tips</button>
          <button type="button" onclick="insertSuggestion('Show me job market insights for London')" class="chip">Job insights</button>
        </div>
      </div>
    </div>

    <!-- Bottom docked input -->
    <form id="chat-form" class="input-dock">
      <div class="input-container" id="inputContainer">
        <textarea id="userInput" rows="1" placeholder="Ask your career question..." oninput="autoResize(this)"></textarea>
        <div class="icon-group">
          <label for="file-upload"><img src="{{ url_for('static', filename='icons/attach.svg') }}" alt="Attach"></label>
          <input id="file-upload" type="file" style="display:none" onchange="handleAttach()">
          <img src="{{ url_for('static', filename='icons/mic.svg') }}" alt="Mic" onclick="handleMic()">
          <img id="sendButton" src="{{ url_for('static', filename='icons/send.svg') }}" alt="Send">
        </div>
      </div>
    </form>
  </section>

  <img id="scrollDown" class="scroll-down-icon" src="{{ url_for('static', filename='icons/scrolldown.svg') }}" alt="Scroll Down" onclick="scrollToBottom()" />
</main>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}
