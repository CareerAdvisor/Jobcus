{% extends "base.html" %}
{% block title %}Chat with Jobcus{% endblock %}
{% block body_class %}chat-page{% endblock %}

{# Left ‚Äúsidebar‚Äù toggle icon in the header #}
{% block header_icon %}
  <img
    id="chatMenuToggle"
    src="{{ url_for('static', filename='icons/sidebar.svg') }}"
    class="header-menu-icon"
    alt="Open chat menu"
    title="Menu"
  />
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">

  {# JSON-LD: SoftwareApplication for the chat experience #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "Jobcus AI Career Chat",
    "applicationCategory": "BusinessApplication",
    "operatingSystem": "Web",
    "url": "https://www.jobcus.com/chat",
    "image": "https://www.jobcus.com/static/images/og/jobcus-og.jpg",
    "description": "Ask career questions in natural language. Jobcus routes you to Resume Analyzer/Builder, Cover Letters, Interview Coach, Skill-Gap, and Job Insights.",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD",
      "url": "https://www.jobcus.com/pricing"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Jobcus",
      "url": "https://www.jobcus.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.jobcus.com/static/icons/apple-touch-icon.png"
      }
    }
  }
  </script>

  {# JSON-LD: Breadcrumbs for the Chat page #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://www.jobcus.com/" },
      { "@type": "ListItem", "position": 2, "name": "AI Career Chat", "item": "https://www.jobcus.com/chat" }
    ]
  }
  </script>
{% endblock %}

{% set show_footer = false %}

{# --- Plan/model helpers (robust defaults) --- #}
{% set plan_code = (plan if plan is defined else ((current_user.plan if current_user.is_authenticated else '') or 'free')) %}
{% set is_paid   = (is_paid if is_paid is defined else (plan_code != 'free')) %}
{% set free_model    = (free_model if free_model is defined else 'gpt-4o-mini') %}
{% set model_default = (model_default if model_default is defined else (is_paid and 'gpt-4o-mini' or free_model)) %}
{% set model_options = (model_options if model_options is defined else ['gpt-4o','gpt-4o-mini']) %}
{% set show_upgrade  = (show_upgrade if show_upgrade is defined else (plan_code == 'free')) %}
{% set cloud_history = 1 if plan_code in ['standard','premium'] else 0 %}

{% block content %}
<main id="chatShell"
      data-is-paid="{{ 1 if is_paid else 0 }}"
      data-plan="{{ plan_code }}"
      data-cloud-history="{{ cloud_history }}"
      data-default-model="{{ model_default }}"
      data-free-model="{{ free_model }}"
      data-allowed-models="{{ ','.join(model_options) }}"
      data-first-name="{{ (current_user.fullname.split(' ')[0] if (current_user.is_authenticated and current_user.fullname) else (current_user.email.split('@')[0] if current_user.is_authenticated else '') ) }}">

  <!-- LEFT: fixed sidebar -->
  <aside id="chatSidebar" class="chat-sidebar" aria-label="Chat menu">
    <div class="sidebar-header">
      <button id="chatSidebarClose" class="sb-btn" type="button" aria-label="Close menu">‚úï Close</button>
      <button id="newChatBtn" class="sb-btn sb-primary" type="button">New chat</button>
    </div>

    <nav class="sb-menu">
      <a class="sb-btn" href="{{ url_for('pricing') }}">View pricing</a>
      <a class="sb-btn" href="{{ url_for('dashboard') }}">Back to dashboard</a>
      <button id="clearChatBtn" class="sb-btn" type="button">Clear conversation</button>
    </nav>

    <section class="credits-panel is-card" aria-labelledby="credits-title">
      <h2 id="credits-title" class="credits-title">AI Chat credits &amp; fair-use</h2>

      <div class="credits-topgrid">
        <div class="credits-col">
          <span class="credits-label">Your plan</span>
          <div class="credits-planline">
            <strong id="credits-plan" data-plan="{{ plan_code }}">{{ plan_code|capitalize }}</strong>
            <span class="pill pill-muted">
              {% if plan_code == 'free' %}Trial{% else %}Active{% endif %}
            </span>
          </div>
        </div>

        <div class="credits-col credits-right">
          <span class="credits-label">Messages left</span>
          <div class="credits-leftline">
            <strong id="credits-left">‚Äî</strong>
            <div class="credits-sub" id="credits-reset">
              {% if plan_code == 'free' %}Trial{% elif plan_code == 'weekly' %}Resets weekly{% elif plan_code == 'standard' %}Resets monthly{% else %}Resets yearly{% endif %}
            </div>
          </div>
        </div>
      </div>

      {% if show_upgrade %}
        <a class="credits-upgrade" href="{{ url_for('pricing') }}">Upgrade</a>
      {% endif %}

      <hr class="credits-div" />

      <div class="model-block">
        <span class="credits-label">Model</span>
        {% if is_paid %}
          <select id="modelSelect" class="model-select" aria-label="Choose AI model">
            {% for m in model_options %}
              <option value="{{ m }}" {% if m == model_default %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        {% else %}
          <span class="pill model-pill" id="modelBadge" title="Free plan model">{{ free_model }}</span>
        {% endif %}
      </div>

      <details class="credits-details" style="margin-top:10px;">
        <summary>How credits work</summary>
        <ul class="credits-list">
          <li><strong>Free:</strong> 10 total messages (trial)</li>
          <li><strong>Weekly:</strong> 100 / week</li>
          <li><strong>Standard:</strong> 600 / month</li>
          <li><strong>Premium:</strong> 10,800 / year (~1,000 / mo)</li>
        </ul>
      </details>
    </section>

    <section class="history-panel">
      <h3 class="history-title">Conversation history</h3>
      <ul id="chatHistory" class="history-list" aria-live="polite"></ul>
      <div id="historyEmpty" class="history-empty" hidden>No saved conversations yet.</div>
    </section>
  </aside>
  <div id="chatOverlay" class="chat-overlay" hidden></div>

  <!-- RIGHT: chat content pane -->
  <section class="chat-main">
    <!-- IMPORTANT: keep both id AND class so chat.css selectors apply -->
    <div class="chatbox" id="chatbox" aria-live="polite">
      <div id="welcomeBanner" class="welcome">
        {% set first_name = (current_user.fullname.split(' ')[0] if (current_user.is_authenticated and current_user.fullname) else (current_user.email.split('@')[0] if current_user.is_authenticated else '')) %}
        {% if first_name %}
          <p class="welcome-title">üëã Welcome {{ first_name }}! How can I help you today?</p>
        {% else %}
          <p class="welcome-title">üëã Welcome! How can I help you today?</p>
        {% endif %}

        <div class="suggestion-chips">
          <button type="button" data-suggest="How do I improve my resume?" class="chip">Improve my resume</button>
          <button type="button" data-suggest="Interview tips for a UX role" class="chip">Interview tips</button>
          <button type="button" data-suggest="Show me job market insights for London" class="chip">Job insights</button>
        </div>
      </div>

      <!-- FEATURE PROMOS (below the welcome message, outside #chatbox so they persist) -->
      <section class="chat-promos" aria-label="Quick tools">
        <a class="promo-card" href="/resume-analyzer">
          <div class="promo-head">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 2h8l4 4v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V6h3.5L14 3.5zM8 9h8v1.6H8V9zm0 3h8v1.6H8V12zm0 3h5.5v1.6H8V15z"/></svg>
            <span class="promo-title">Resume Analyzer</span>
          </div>
          <p class="promo-copy">Upload your resume to get an ATS score, keyword match, and quick, actionable fixes.</p>
          <span class="promo-cta" aria-hidden="true">Open ‚Üí</span>
        </a>
      
        <a class="promo-card" href="/interview-coach">
          <div class="promo-head">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H8.5v2H15v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/></svg>
            <span class="promo-title">Interview Coach</span>
          </div>
          <p class="promo-copy">Practice role-specific questions and get feedback on clarity, tone, and confidence.</p>
          <span class="promo-cta" aria-hidden="true">Start ‚Üí</span>
        </a>
      </section>
      
    </div>
        
    <div id="chatNotice" class="chat-notice" hidden role="alert"></div>

    <!-- Bottom docked input -->
    <form id="chat-form" class="input-dock" autocomplete="off" novalidate>
      <div id="inputContainer"
           class="input-container"
           data-ai-caveat
           data-caveat-text="AI-generated responses may contain mistakes. Learn more!"
           data-caveat-link="/ai-disclaimer"
           data-caveat-inline="0"
           data-caveat-closable="1"
           data-caveat-once="1">
        <textarea id="userInput" rows="1" placeholder="Ask your career question..." oninput="autoResize(this)" aria-label="Type your message"></textarea>
        <div class="icon-group">
          <label for="file-upload" title="Attach a file">
            <img src="{{ url_for('static', filename='icons/attach.svg') }}" alt="Attach">
          </label>
          <input id="file-upload" type="file" style="display:none" onchange="handleAttach()">
          <img src="{{ url_for('static', filename='icons/mic.svg') }}" alt="Voice input" onclick="handleMic()">
          <img id="sendButton" src="{{ url_for('static', filename='icons/send.svg') }}" alt="Send" role="button" tabindex="0">
        </div>
      </div>
    </form>
  </section>

  {# Scroll-to-bottom icon ‚Äî now present in DOM #}
  <img id="scrollDown" class="scroll-down-icon"
       src="{{ url_for('static', filename='icons/scrolldown.svg') }}"
       alt="Scroll Down"
       title="Jump to latest"
       onclick="(function(){const c=document.getElementById('chatbox'); if(c){c.scrollTop=c.scrollHeight;}})()" />
</main>
{% endblock %}

{% block scripts %}
  {# Self-hosted libs so CSP 'script-src self' passes #}
  <script src="{{ url_for('static', filename='vendor/marked/marked.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/dompurify/purify.min.js') }}"></script>

  {# Harden: sanitize whatever marked renders #}
  <script>
    (function () {
      if (window.marked && window.DOMPurify) {
        const origParse = marked.parse.bind(marked);
        marked.parse = function(md){ return DOMPurify.sanitize(origParse(md)); };
      }
    })();
  </script>

  <!-- Main chat logic -->
  <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>

  <!-- Small boot script to wire the scroll icon immediately -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const box = document.getElementById('chatbox');
      if (box) {
        box.addEventListener('scroll', () => window.maybeShowScrollIcon?.());
      }
      window.maybeShowScrollIcon?.();
    });
  </script>
{% endblock %}
